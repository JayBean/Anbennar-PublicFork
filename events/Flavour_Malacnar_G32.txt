
namespace = flavor_malacnar

#You slay the Malacnar battleking
country_event = {
	id = flavor_malacnar.2
	title = flavor_malacnar.2.t
	desc = flavor_malacnar.2.d
	picture = BATTLE_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.2.a
		
		if = {
			limit = {
				has_global_flag = malacnar_killed_legendary
			}
			add_mil_power = 100
			add_prestige = 30
		}
		else_if = {
			limit = {
				has_global_flag = malacnar_killed_veteran
			}
			add_mil_power = 50
			add_prestige = 20
		}
		else = {
			add_prestige = 10
		}
		
		ai_chance = {
			factor = 1
		}
	}
}

#Your Battleking gets slain
country_event = {
	id = flavor_malacnar.3
	title = flavor_malacnar.3.t
	desc = {
		trigger = {
			NOT = {
				has_ruler_modifier = g32_cowardly_battleking
				has_ruler_modifier = g32_untested_battleking
			}
		}
	   desc = flavor_malacnar.3.d1
	}
	desc = {
	   trigger = {
			OR = {
				has_ruler_modifier = g32_cowardly_battleking
				has_ruler_modifier = g32_untested_battleking
			}
		}
	   desc = flavor_malacnar.3.d2
	}
	picture = BATTLE_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
	}
	
	immediate = {
		clr_global_flag = malacnar_killed_legendary
		clr_global_flag = malacnar_killed_veteran
		if = {
			limit = {
				G32 = {
					OR = {
						has_ruler_modifier = g32_legendary_battleking
						has_ruler_modifier = mythical_conqueror_modifier
					}
				}
			}
			set_global_flag = malacnar_killed_legendary
		}
		else_if = {
			limit = {
				G32 = {
					OR = {
						has_ruler_modifier = g32_veteran_battleking
						has_ruler_modifier = great_conqueror_modifier
					}
				}
			}
			set_global_flag = malacnar_killed_veteran
		}
	}
	
	option = {
		name = flavor_malacnar.3.a
		
		trigger = {
			NOT = {
				has_ruler_modifier = g32_cowardly_battleking
				has_ruler_modifier = g32_untested_battleking
			}
		}
		
		kill_ruler = yes
		
		add_prestige = -20
		
		add_stability = -1
		custom_tooltip = malacnar_stability_tooltip
		
		if = {
			limit = {
				NOT = {
					has_heir = yes
				}
			}
			
			custom_tooltip = malacnar_emergency_meeting_tooltip
			
			add_mil_power = -50
		
		}
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {
		name = flavor_malacnar.3.b
		
		trigger = {
			OR = {
				has_ruler_modifier = g32_cowardly_battleking
				has_ruler_modifier = g32_untested_battleking
			}
		}
		
		kill_ruler = yes
		
		add_prestige = -20
		
		if = {	 #Punish Exploits
			limit = {
				is_at_war = no
			}
			reduce_stability_or_adm_power = yes
			reduce_stability_or_adm_power = yes
		}
		
		if = {
			limit = {
				is_at_war = yes
			}
			reduce_stability_or_adm_power = yes
			custom_tooltip = malacnar_stability_tooltip
		}
		
		if = {
			limit = {
				NOT = {
					has_heir = yes
				}
			}
			custom_tooltip = malacnar_emergency_meeting_tooltip
			add_mil_power = -50
		}
		
		ai_chance = {
			factor = 1
		}
	}
}

#New Battleking Ascension Event
country_event = {
	id = flavor_malacnar.4
	title = flavor_malacnar.4.t
	desc = {
		trigger = {
			OR = {
				is_female = no
				has_country_flag = g32_past_queen
			}
		}
	   desc = flavor_malacnar.4.d1
	}
	desc = {	#Text changes if female battlequeen
	   trigger = {
			is_female = yes
			NOT = { has_country_flag = g32_past_queen }
		}
	   desc = flavor_malacnar.4.d2
	}
	
	picture = {
		trigger = { is_female = no }
		picture = REFORM_eventPicture
	}
	picture = {
		trigger = { is_female = yes has_dlc = "Women in History" }
		picture = wihgfx_FEMALE_GENERAL_eventPicture
	}
	picture = {
		trigger = { is_female = yes NOT = { has_dlc = "Women in History" } }
		picture = QUEEN_AT_COUNCIL_TABLE_eventPicture
	}
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
		has_regency = no
	}

	option = {
		name = flavor_malacnar.4.a
		
		trigger = {
			is_female = no
			NOT = { primary_culture = malacnari }
		}
		
		hidden_effect = { remove_country_modifier = g32_battleking_grace_period }

		if = {
			limit = {
				ai = no
			}
			add_ruler_modifier = {	#Two years and a half
				name = g32_battleking_grace_period
				duration = 912
				hidden = yes
			}
		}
		else = {
			add_ruler_modifier = {	#Ten years for AI
				name = g32_battleking_grace_period
				duration = 3650
				hidden = yes
			}
		}
		
		add_ruler_modifier = {
			name = g32_untested_battleking
		}
		
		hidden_effect = {
			set_ai_personality = {
				personality = ai_militarist
				locked = no
			}
		}
			
		custom_tooltip = malacnar_battleking_rep_tooltip
		
		ai_chance = {
			factor = 1
		}
	}

	option = {
		name = flavor_malacnar.4.d
		
		trigger = {
			is_female = no
			primary_culture = malacnari
		}
		
		hidden_effect = { remove_country_modifier = g32_battleking_grace_period }

		if = {
			limit = {
				ai = no
			}
			add_ruler_modifier = {	#Two years and a half
				name = g32_battleking_grace_period
				duration = 912
				hidden = yes
			}
		}
		else = {
			add_ruler_modifier = {	#Ten years for AI
				name = g32_battleking_grace_period
				duration = 3650
				hidden = yes
			}
		}
		
		add_ruler_modifier = {
			name = g32_untested_battleking
		}
		
		hidden_effect = {
			set_ai_personality = {
				personality = ai_militarist
				locked = no
			}
		}
			
		custom_tooltip = malacnar_battleking_rep_tooltip
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {	#Battlequeen transition goes smoothly
		name = flavor_malacnar.4.b
		
		trigger = {
			is_female = yes
			OR = {
				has_country_modifier = g32_legacy_battlequeen
				stability = 1
			}
		}
		
		hidden_effect = { remove_country_modifier = g32_battleking_grace_period }
		
		add_ruler_modifier = {
			name = g32_battlequeen
			hidden = yes
		}
		
		set_country_flag = g32_past_queen

		if = {
			limit = {
				ai = no
			}
			add_ruler_modifier = {	#Less than two years
				name = g32_battleking_grace_period
				duration = 600
				hidden = yes
			}
		}
		else = {
			add_ruler_modifier = {	#Five years for AI
				name = g32_battleking_grace_period
				duration = 1825
				hidden = yes
			}
		}
		
		add_ruler_modifier = {
			name = g32_untested_battleking
		}
		
		hidden_effect = {
			set_ai_personality = {
				personality = ai_militarist
				locked = no
			}
		}
			
		custom_tooltip = malacnar_battleking_rep_tooltip
		
		ai_chance = {
			factor = 100
		}
	}
	
	option = {	#Battlequeen is challenged
		name = flavor_malacnar.4.c
		
		trigger = {
			is_female = yes
			NOT = {
				has_country_modifier = g32_legacy_battlequeen
			}
		}
		
		hidden_effect = { remove_country_modifier = g32_battleking_grace_period }
		
		random_province = {
			limit = { area = malacnar_area }
			
			spawn_rebels = {
				type = pretender_rebels
				size = 2
			}
		}
		
		add_ruler_modifier = {
			name = g32_battlequeen
			hidden = yes
		}
		
		set_country_flag = g32_past_queen

		if = {
			limit = {
				ai = no
			}
			add_ruler_modifier = {	#Less than two years
				name = g32_battleking_grace_period
				duration = 600
				hidden = yes
			}
		}
		else = {
			add_ruler_modifier = {	#Five years for AI
				name = g32_battleking_grace_period
				duration = 1825
				hidden = yes
			}
		}
		
		add_ruler_modifier = {
			name = g32_untested_battleking
		}
		
		hidden_effect = {
			set_ai_personality = {
				personality = ai_militarist
				locked = no
			}
		}
			
		custom_tooltip = malacnar_battleking_rep_tooltip
		
		ai_chance = {
			factor = 1
		}
	}
}

#Reforming the country
country_event = {
	id = flavor_malacnar.5
	title = flavor_malacnar.5.t
	desc = flavor_malacnar.5.d
	picture = REFORM_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
	}
	
	option = {	#keep the elective stratocracy
		name = flavor_malacnar.5.a
		
		change_government = republic
		add_government_reform = malacnar_republic_reform
		
		if = {
			limit = {
				has_reform = states_general_reform
			}
			remove_government_reform = states_general_reform
		}
		
		ai_chance = {
			factor = 3
		}
	}
	
	option = {	#let's make Malacnar into a hereditary monarchy because why not
		name = flavor_malacnar.5.b
		
		trigger = { government = monarchy }
		
		if =  {
			limit = {
				NOT = {
					has_ruler_modifier = g32_legendary_battleking
				}
				calc_true_if = {
					has_reform = enforce_privileges_reform
					has_reform = decentralize_reform
					has_reform = states_general_reform
					has_country_modifier = yrw_2b	#decentralization reform
					NOT = { legitimacy = 80 }
					NOT = {
						has_ruler_modifier = g32_bloodied_battleking
						has_ruler_modifier = g32_veteran_battleking
					}
					amount = 1
				}
			}
			add_stability = -1
		}
		
		if =  {
			limit = {
				NOT = {
					has_ruler_modifier = g32_veteran_battleking
					has_ruler_modifier = g32_legendary_battleking
				}
				calc_true_if = {
					has_reform = enforce_privileges_reform
					has_reform = decentralize_reform
					has_reform = states_general_reform
					has_country_modifier = yrw_2b	#decentralization reform
					NOT = { legitimacy = 80 }
					NOT = {
						has_ruler_modifier = g32_bloodied_battleking
					}
					amount = 2
				}
			}
			custom_tooltip = malacnar_really_good_idea_tooltip
			hidden_effect = {
				malacnar_area = {
					spawn_rebels = {
						type = pretender_rebels
						size = 2
					}
				}
				add_manpower = -27
			}
		}
		
		change_government_to_monarchy = yes
		add_government_reform = malacnar_monarchy_reformed
		
		define_heir = {
			age = 12
			dynasty = ROOT
			claim = 50
		}
		
		if = {
			limit = {
				has_reform = states_general_reform
			}
			remove_government_reform = states_general_reform
		}
		
		ai_chance = {
			factor = 0	#disabling this choice for the AI as it would stop using its monarchs for battle
			
			modifier = {
				factor = 10
				OR = {
					ruler_has_personality = lawgiver_personality
					ruler_has_personality = cruel_personality
					ruler_has_personality = greedy_personality
					ruler_has_personality = malevolent_personality
				}
			}
			
			modifier = {
				factor = 0.5
				OR = {
					has_reform = enforce_privileges_reform
					has_reform = decentralize_reform
					has_reform = states_general_reform
					NOT = { legitimacy = 80 }
				}
			}
		}
	}
}

#Utility Event that plays for every won battle
country_event = {
	id = flavor_malacnar.6
	title = flavor_malacnar.6.t
	desc = flavor_malacnar.6.d
	picture = BATTLE_eventPicture
	
	is_triggered_only = yes
	hidden = yes
	
	immediate = {
		remove_country_modifier = g32_battleking_fought_recently
		add_authority = 1
	}
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
	}
	
	option = {
		name = flavor_malacnar.6.a

		if = {	#You won't get questioned for cowardice during this period
			limit = {
				ai = no
			}
			add_ruler_modifier = {	#5 years for players
				name = g32_battleking_fought_recently
				duration = 1825
			}
		}
		else = {
			add_ruler_modifier = {	#10 years for AI
				name = g32_battleking_fought_recently
				duration = 3650
			}
		}
		
		if = {	#Chance to "level" up
			limit = {
				OR = {
					has_ruler_modifier = g32_untested_battleking
					has_ruler_modifier = g32_cowardly_battleking
				}
			}
			random = {
				chance = 50
				country_event = { id = flavor_malacnar.7 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_ruler_modifier = g32_tested_battleking
					has_ruler_modifier = g32_legendary_battleking
				}
			}
			random = {
				chance = 20
				country_event = { id = flavor_malacnar.7 }
			}
		}
		else_if = {
			limit = {
				has_ruler_modifier = g32_bloodied_battleking
			}
			random = {
				chance = 10
				country_event = { id = flavor_malacnar.7 }
			}
		}
		else_if = {
			limit = {
				has_ruler_modifier = g32_veteran_battleking
			}
			random = {
				chance = 5
				country_event = { id = flavor_malacnar.7 }
			}
		}
		
		if = {	#chance of woman Battlequeen putting doubters to rest
			limit = {
				is_female = yes
			}
			if = {
				limit = {
					has_ruler_modifier = g32_tested_battleking
				}
				random = {
					chance = 20
					country_event = { id = flavor_malacnar.10 }
				}
			}
			else_if = {
				limit = {
					has_ruler_modifier = g32_bloodied_battleking
				}
				random = {
					chance = 50
					country_event = { id = flavor_malacnar.10 }
				}
			}
			else_if = {
				limit = {
					OR = {
						has_ruler_modifier = g32_veteran_battleking
						has_ruler_modifier = g32_legendary_battleking
					}
				}
				country_event = { id = flavor_malacnar.10 }
			}
		}
		
		ai_chance = {
			factor = 1
		}
	}
}

#Battleking Reberu-appo
country_event = {
	id = flavor_malacnar.7
	title = flavor_malacnar.7.t
	desc = flavor_malacnar.7.d
	picture = BATTLE_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
	}
	
	option = {
		name = flavor_malacnar.7.a
		
		malacnar_battleking_rankup = yes
		
		ai_chance = {
			factor = 1
		}
	}
}

#Punishing the player for not having the battleking fight
country_event = {
	id = flavor_malacnar.8
	title = flavor_malacnar.8.t
	desc = {
		trigger = {
			has_ruler_modifier = g32_untested_battleking
		}
	   desc = flavor_malacnar.8.d1
	}
	desc = {
	   trigger = {
			has_ruler_modifier = g32_cowardly_battleking
		}
	   desc = flavor_malacnar.8.d2
	}
	desc = {
	   trigger = {
			has_ruler_modifier = g32_tested_battleking
		}
	   desc = flavor_malacnar.8.d3
	}
	desc = {
	   trigger = {
			OR = {
				has_ruler_modifier = g32_bloodied_battleking
				has_ruler_modifier = g32_veteran_battleking
			}
		}
	   desc = flavor_malacnar.8.d4
	}
	picture = DEBATE_REPUBLICAN_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
		NOT = {
			has_ruler_modifier = g32_battleking_fought_recently
			has_ruler_modifier = g32_battleking_grace_period
			has_ruler_modifier = g32_legendary_battleking
			has_country_modifier = malacnar_moment_peace #From "A Deep Breath Before War" mission.
			has_regency = yes
		}
	}
	
	immediate = {
		if = {
			limit = {
				ai = yes	#players get a 2 year grace period already as it's a pulse event
			}
			add_ruler_modifier = {	#Five years grace period for AI
				name = g32_battleking_grace_period
				duration = 1825
				hidden = yes
			}
		}
	}
	
	option = {
		name = flavor_malacnar.8.a
		trigger = { has_ruler_modifier = g32_untested_battleking }
		
		malacnar_battleking_rankdown = yes
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {
		name = flavor_malacnar.8.b
		trigger = { has_ruler_modifier = g32_cowardly_battleking }
		
		malacnar_battleking_rankdown = yes
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {
		name = flavor_malacnar.8.c
		trigger = { has_ruler_modifier = g32_tested_battleking }
		
		malacnar_battleking_rankdown = yes
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {
		name = flavor_malacnar.8.d
		trigger = {
			OR = {
				has_ruler_modifier = g32_bloodied_battleking
				has_ruler_modifier = g32_veteran_battleking
			}
		}
		
		malacnar_battleking_rankdown = yes
		
		ai_chance = {
			factor = 1
		}
	}
}

#Child Ruler
country_event = {
	id = flavor_malacnar.9
	title = flavor_malacnar.9.t
	desc = flavor_malacnar.9.d
	picture = COUNTRY_COLLAPSE_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
		NOT = { has_country_flag = no_new_succession_crisis_if_pretender_rebels }
		has_regency = yes
	}
	
	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = {
					is_capital = no
					is_state = yes
				}
				spawn_rebels = {
					type = pretender_rebels
					size = 2
					win = yes
				}
			}
		}
	}
	
	option = {
		name = flavor_malacnar.9.a
		if = {
			limit = {
				NOT = { num_of_generals = 1 }
			}
			define_general = { }
		}
		define_leader_to_ruler = {
		}
		kill_heir = { allow_new_heir = no }
		add_stability = -1
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {
		name = flavor_malacnar.9.b
		define_ruler = {
			name = "Royal Battleguards"
			dynasty = "of Malacnar"
			claim = 50
			change_mil = 1
			regency = yes
			hide_skills = yes
		}
		kill_leader = {
			type = general
		}
		random_province = {
			limit = { area = malacnar_area }
			
			spawn_rebels = {
				type = pretender_rebels
				size = 2
			}
		}
		add_ruler_modifier = {
			name = g32_battleregency
		}
		
		ai_chance = {
			factor = 1
		}
	}
}

#Woman Battlequeen Proves Herself
country_event = {
	id = flavor_malacnar.10
	title = flavor_malacnar.10.t
	desc = flavor_malacnar.10.d
	picture = {
		trigger = { has_dlc = "Women in History" }
		picture = wihgfx_FEMALE_GENERAL_eventPicture
	}
	picture = {
		trigger = { NOT = { has_dlc = "Women in History" } }
		picture = QUEEN_AT_COUNCIL_TABLE_eventPicture
	}
	
	is_triggered_only = yes
	
	trigger = {
		tag = G32
		OR = {
			has_reform = malacnar_monarchy
			has_reform = malacnar_monarchy_reformed
			has_reform = malacnar_republic_reform
		}
		NOT = { has_country_modifier = g32_legacy_battlequeen }
		is_female = yes
		OR = {
			has_ruler_modifier = g32_bloodied_battleking
			has_ruler_modifier = g32_veteran_battleking
			has_ruler_modifier = g32_legendary_battleking
		}
	}

	option = {
		name = flavor_malacnar.10.a
		
		add_country_modifier = {
			name = g32_legacy_battlequeen
			duration = -1  
		}
		
		ai_chance = {
			factor = 1
		}
	}
	
	option = {
		name = flavor_malacnar.10.b
		
		add_country_modifier = {	#20 years
			name = g32_legacy_battlequeen
			duration = 7300
		}
		
		add_country_modifier = {	#still able to get female generals for a century
			name = g32_battlequeen
			duration = 14600
			hidden = yes
		}
		
		ai_chance = {
			factor = 0
		}
	}
}

#Events 101-1?? are triggered by the mission tree
#The First Companion
country_event = {
	id = flavor_malacnar.101
	title = flavor_malacnar.101.t
	desc = flavor_malacnar.101.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.101.a
		add_historical_friend = G32
		G32 = {
			add_historical_friend = ROOT
			country_event = { id = flavor_malacnar.102 days = 1 }
		}
		add_country_modifier = {
			name = malacnar_fight_three
			duration = 10950
		}
		remove_country_modifier = ynn_diplo
		every_known_country = {
			limit = { alliance_with = ROOT }
			ROOT = {
				break_alliance = PREV
			}
		}
	}
}
#Notify of First Companion
country_event = {
	id = flavor_malacnar.102
	title = flavor_malacnar.102.t
	desc = flavor_malacnar.102.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			FROM = { release_iosahar = yes }
			create_alliance = FROM
			random_ally = {
				limit = {
					has_opinion = {
						who = G32
						value = 100
					}
					culture_group = ynnic_ruinborn_elf
					NOT = { has_opinion_modifier = { who = G32 modifier = allied_to_rival } }
					NOT = { has_country_flag = malacnar_companion }
				}
				country_event = { id = flavor_malacnar.103 days = 1 }
			}
		}
	}
	option = {
		name = flavor_malacnar.102.a
		add_prestige = 5
		FROM = { add_prestige = 5 }
	}
}

#The Second Companion (same loc as the first)
country_event = {
	id = flavor_malacnar.103
	title = flavor_malacnar.101.t
	desc = flavor_malacnar.101.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.101.a
		set_country_flag = malacnar_companion
		add_historical_friend = G32
		G32 = {
			country_event = { id = flavor_malacnar.104 days = 1 }
			add_historical_friend = ROOT
		}
		add_country_modifier = {
			name = malacnar_fight_three
			duration = 10950
		}
		remove_country_modifier = ynn_diplo
		random_country = {
			limit = {
				has_country_flag = malacnar_companion
			}
			country_event = { id = flavor_malacnar.105 days = 1 }
		}
		every_known_country = {
			limit = { alliance_with = ROOT }
			ROOT = {
				break_alliance = PREV
			}
		}
	}
}
#Notify of Second Companion
country_event = {
	id = flavor_malacnar.104
	title = flavor_malacnar.102.t
	desc = flavor_malacnar.102.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			FROM = { release_iosahar = yes }
			create_alliance = FROM
		}
	}
	
	option = {
		name = flavor_malacnar.102.a
		add_prestige = 5
		FROM = { add_prestige = 5 }
		#set_country_flag = malacnar_companion
	}
}
#Make sure the two companions are not historic rivals
country_event = {
	id = flavor_malacnar.105
	title = flavor_malacnar.105.t
	desc = flavor_malacnar.105.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.105.a
		remove_historical_rival = FROM
		add_prestige = 5
		FROM = {
			remove_historical_rival = ROOT
			country_event = { id = flavor_malacnar.106 days = 1 }
		}
	}
}
#Ally the two other companions together
country_event = {
	id = flavor_malacnar.106
	title = flavor_malacnar.105.t
	desc = flavor_malacnar.105.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.105.a
		add_historical_friend = FROM
		add_prestige = 5
		FROM = {
			add_historical_friend = ROOT
			create_alliance = ROOT
		}
	}
}
#Request the Companions become subject
country_event = {
	id = flavor_malacnar.107
	title = flavor_malacnar.107.t
	desc = flavor_malacnar.107.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.107.a
		ai_chance = { factor = 100 }
		G32 = { country_event = { id = flavor_malacnar.108 days = 1 } }
		country_event = { id = flavor_malacnar.120 days = 9125 random = 730 }
	}
	option = {
		name = flavor_malacnar.107.b
		ai_chance = { factor = 0 }
		G32 = { country_event = { id = flavor_malacnar.109 days = 1 } }
	}
}
#Positive Response
country_event = {
	id = flavor_malacnar.108
	title = flavor_malacnar.108.t
	desc = flavor_malacnar.108.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.108.a
		add_prestige = 5
		tooltip = {
			create_iosahar = { tag = FROM }
		}
		hidden_effect = {
			FROM = { country_event = { id = ynn_events.20 } }
		}
		clr_global_flag = G32_companions_active
	}
}
#Negative Response
country_event = {
	id = flavor_malacnar.109
	title = flavor_malacnar.109.t
	desc = flavor_malacnar.109.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.109.a
		add_prestige = -5
	}
}
#Turn Companion to normal vassal
country_event = {
	id = flavor_malacnar.110
	title = flavor_malacnar.110.t
	desc = flavor_malacnar.110.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.110.a
		add_prestige = 5
		create_subject = {
			subject_type = vassal
			subject = FROM
		}
		clr_global_flag = G32_companions_active
	}
}
#Battleking vs Gunslinger
country_event = {
	id = flavor_malacnar.111
	title = flavor_malacnar.111.t
	desc = flavor_malacnar.111.d
	picture = TRADE_GOODS_FURS_FISH_AND_SALT_eventPicture
	goto = 1165
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.111.a
		trigger = {
			NOT = { primary_culture = malacnari }
		}
		if = {
			limit = {
				OR = {
					mil = 5
					has_ruler_modifier = g32_bloodied_battleking
					has_ruler_modifier = g32_veteran_battleking
					has_ruler_modifier = g32_legendary_battleking
					ruler_has_mage_personality = yes
				}
			}
			country_event = { id = flavor_malacnar.116 }
		}
		else = {
			country_event = { id = flavor_malacnar.117 }
		}
	}
	option = {
		name = flavor_malacnar.111.b
		trigger = {
			primary_culture = malacnari
		}
		if = {
			limit = {
				OR = {
					mil = 5
					has_ruler_modifier = g32_bloodied_battleking
					has_ruler_modifier = g32_veteran_battleking
					has_ruler_modifier = g32_legendary_battleking
					ruler_has_mage_personality = yes
				}
			}
			country_event = { id = flavor_malacnar.116 }
		}
		else = {
			country_event = { id = flavor_malacnar.117 }
		}
	}
}
#Steal some relics
country_event = {
	id = flavor_malacnar.112
	title = flavor_malacnar.112.t
	desc = {
		trigger = {
			ynn_cannorian_thought = no
		}
	   desc = flavor_malacnar.112.d1
	}
	desc = {
	   trigger = {
			ynn_cannorian_thought = yes
		}
	   desc = flavor_malacnar.112.d2
	}
	picture = SIEGE_eventPicture
	goto = g32_plunder_province
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			random_province = {
				limit = {
					colonial_region = colonial_eordand
					trade_goods = precursor_relics
					controlled_by = ROOT
				}
				save_event_target_as = g32_plunder_province
			}
		}
	}	
	
	option = {	#destroy the relics
		name = flavor_malacnar.112.a
		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				ruler_has_personality = zealot_personality
			}
		}
		event_target:g32_plunder_province = {
			add_base_tax = -1
			add_base_production = -2
			add_devastation = 80
			set_from_saved_trade_goods = yes # If it got PRs from having them randomly spawn, return them, otherwise give random
		}
		if = {
			limit = {
				ynn_cannorian_thought = yes
			}
			add_estate_loyalty = {
				estate = estate_church
				loyalty = 5
			}
		}
		else = {
			add_estate_loyalty = {
				estate = estate_church
				loyalty = 10
			}
		}
	}
	
	option = {
		name = flavor_malacnar.112.b
		ai_chance = {
			factor = 5
			modifier = {
				factor = 4
				ynn_cannorian_thought = yes
			}
		}
		goto = 2808
		event_target:g32_plunder_province = {
			add_base_tax = -1
			add_base_production = -2
			add_devastation = 80
			set_from_saved_trade_goods = yes # If it got PRs from having them randomly spawn, return them, otherwise give random
		}
		2808 = {
			change_trade_goods = precursor_relics
			add_base_production = 2
		}
		if = {
			limit = {
				ynn_cannorian_thought = yes
			}
			add_estate_loyalty = {
				estate = estate_church
				loyalty = -5
			}
		}
		else = {
			add_estate_loyalty = {
				estate = estate_church
				loyalty = -10
			}
		}
	}
}
#The Embers of the Domandrod
country_event = {
	id = flavor_malacnar.113
	title = flavor_malacnar.113.t
	desc = flavor_malacnar.113.d
	picture = FEYFOREST_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.113.a
		eordand_superregion = {
			north_america = {
				limit = {
					has_terrain = ancient_forest
					controlled_by = ROOT
				}
				add_devastation = 80
			}
		}
		if = {
			limit = {
				ynn_cannorian_thought = yes
			}
			add_estate_loyalty = {
				estate = estate_church
				loyalty = 5
			}
		}
		else = {
			add_estate_loyalty = {
				estate = estate_church
				loyalty = 10
			}
		}
		add_power_projection = {
			type = mission_rewards_power_projection
			amount = 10
        }
		every_country = {
			limit = {
				culture_group = eordan_ruinborn_elf
				capital_scope = { superregion = eordand_superregion }
			}
			country_event = { id = flavor_malacnar.119 }
		}
	}
}
#Send event to Malacnar
country_event = {
	id = flavor_malacnar.114
	title = flavor_malacnar.1025.t
	desc = flavor_malacnar.1025.d
	picture = SIEGE_eventPicture
	
	is_triggered_only = yes
	hidden = yes
	
	immediate = {
		hidden_effect = { FROM = { country_event = { id = flavor_malacnar.115 } } }
	}
	
	option = {
		name = flavor_malacnar.1025.a
		ai_chance = { factor = 100 }
	}
}
#Malacnari Glory Tradition Gain
country_event = {
	id = flavor_malacnar.115
	title = flavor_malacnar.115.t
	desc = flavor_malacnar.115.d
	picture = SIEGE_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.115.a
		ai_chance = { factor = 100 }
		if = {
			limit = { FROM = { is_great_power = yes } }
			add_army_tradition = 25
		}
		else_if = {
			limit = { FROM = { is_rival = ROOT } }
			add_army_tradition = 20
		}
		else_if = {
			limit = { FROM = { total_development = 250 } }
			add_army_tradition = 15
		}
		else_if = {
			limit = { FROM = { total_development = 150 } }
			add_army_tradition = 10
		}
		else_if = {
			limit = { FROM = { total_development = 100 } }
			add_army_tradition = 5
		}
	}
}
#Battleking Beats Gunslinger
country_event = {
	id = flavor_malacnar.116
	title = flavor_malacnar.116.t
	desc = {
		trigger = {
			NOT = {
				ruler_has_mage_personality = yes
			}
		}
	   desc = flavor_malacnar.116.d1
	}
	desc = {
	   trigger = {
			ruler_has_mage_personality = yes
		}
	   desc = flavor_malacnar.116.d2
	}
	picture = TRADE_GOODS_FURS_FISH_AND_SALT_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.116.a
		ai_chance = { factor = 1 }
		
		if = {
			limit = {	#They fail so badly it makes you switch your debate stance	
				has_country_flag = yrw_3a
			}
			custom_tooltip = malacnar_gun_debate_switch_b
			clr_country_flag = yrw_3a
			set_country_flag = yrw_3b
			add_prestige = -5
		}
		else_if = {
			limit = {	#Contradicting your chosen reform
				OR = {
					has_country_flag = yrw_3a_reform
					has_country_modifier = yrw_3a
				}
			}
			reduce_stability_or_adm_power = yes
		}
		else_if = {
			limit = {	#They strengthen your stance to reject guns
				OR = {
					has_country_flag = yrw_3b
					has_country_flag = yrw_3b_reform
					has_country_modifier = yrw_3b
				}
			}
			trigger_switch = {
				on_trigger = stability
				3 = { add_adm_power = 100 }
				2 = { add_adm_power = 50 add_stability = 1 }
				-3 = { add_stability = 2 }
			}
		}
		else = {
			add_stability_or_adm_power = yes
		}
		
		malacnar_battleking_rankup = yes
	}
	option = {
		name = flavor_malacnar.116.b
		ai_chance = { factor = 99 }
		
		if = {
			limit = {	#You switch your debate stance	
				has_country_flag = yrw_3b
			}
			custom_tooltip = malacnar_gun_debate_switch_a
			clr_country_flag = yrw_3b
			set_country_flag = yrw_3a
			add_prestige = -5
		}
		else_if = {
			limit = {	#Contradicting your chosen reform
				OR = {
					has_country_flag = yrw_3b_reform
					has_country_modifier = yrw_3b
				}
			}
			reduce_stability_or_adm_power = yes
		}
		
		1165 = {
			add_province_modifier = {
				name = malacnar_meeting
				duration = -1
			}
			add_institution_embracement = {
				which = new_world_i
				value = 30
			}
			add_province_modifier = {
				name = malacnar_rush
				duration = 3650
			}
			add_base_tax = 2
			add_base_production = 2
			add_base_manpower = 2
			add_human_minority_size_effect = yes
			add_dwarven_minority_size_effect = yes
		}
		if = {
			limit = { 2837 = { owned_by_companion = yes } }
			2837 = {
				add_province_modifier = {
					name = malacnar_meeting
					duration = -1
				}
				add_institution_embracement = {
					which = new_world_i
					value = 20
				}
				add_human_minority_size_effect = yes
			}
		}
		if = {
			limit = { 2839 = { owned_by_companion = yes } }
			2839 = {
				add_province_modifier = {
					name = malacnar_meeting
					duration = -1
				}
				add_institution_embracement = {
					which = new_world_i
					value = 20
				}
				add_human_minority_size_effect = yes
			}
		}
	}
}
#Battleking Loses to Gunslinger
country_event = {
	id = flavor_malacnar.117
	title = flavor_malacnar.117.t
	desc = flavor_malacnar.117.d
	picture = TRADE_GOODS_FURS_FISH_AND_SALT_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.117.a
		ai_chance = { factor = 1 }
		
		if = {
			limit = {	#You switch your debate stance	
				has_country_flag = yrw_3a
			}
			custom_tooltip = malacnar_gun_debate_switch_b
			clr_country_flag = yrw_3a
			set_country_flag = yrw_3b
			reduce_stability_or_adm_power = yes
		}
		else_if = {
			limit = {	#Contradicting your chosen reform
				OR = {
					has_country_flag = yrw_3a_reform
					has_country_modifier = yrw_3a
				}
			}
			reduce_stability_or_adm_power = yes
		}

		malacnar_battleking_rankdown = yes
		add_legitimacy = -25
		add_republican_tradition = -10
		
	}
	option = {
		name = flavor_malacnar.117.b
		ai_chance = { factor = 1 }
		
		if = {
			limit = {	#You switch your debate stance	
				has_country_flag = yrw_3b
			}
			custom_tooltip = malacnar_gun_debate_switch_a
			clr_country_flag = yrw_3b
			set_country_flag = yrw_3a
			reduce_stability_or_adm_power = yes
		}
		else_if = {
			limit = {	#Contradicting your chosen reform
				OR = {
					has_country_flag = yrw_3b_reform
					has_country_modifier = yrw_3b
				}
			}
			reduce_stability_or_adm_power = yes
		}
		
		hidden_effect = { kill_ruler = yes }
		custom_tooltip = step_down_tooltip
		
		1165 = {
			add_province_modifier = {
				name = malacnar_meeting
				duration = -1
			}
			add_institution_embracement = {
				which = new_world_i
				value = 50
			}
			add_province_modifier = {
				name = malacnar_rush
				duration = 3650
			}
			add_base_tax = 2
			add_base_production = 2
			add_base_manpower = 2
			add_human_minority_size_effect = yes
			add_dwarven_minority_size_effect = yes
		}
		if = {
			limit = { 2837 = { owned_by_companion = yes } }
			2837 = {
				add_province_modifier = {
					name = malacnar_meeting
					duration = -1
				}
				add_institution_embracement = {
					which = new_world_i
					value = 40
				}
				add_human_minority_size_effect = yes
			}
		}
		if = {
			limit = { 2839 = { owned_by_companion = yes } }
			2839 = {
				add_province_modifier = {
					name = malacnar_meeting
					duration = -1
				}
				add_institution_embracement = {
					which = new_world_i
					value = 40
				}
				add_human_minority_size_effect = yes
			}
		}
	}
}
#Awed by the sea
country_event = {
	id = flavor_malacnar.118
	title = flavor_malacnar.118.t
	desc = flavor_malacnar.118.d
	picture = PRAYING_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.118.a
		ai_chance = { factor = 1 }
		
		1028 = {
			change_province_name = "Ynnshirlad" 
			hidden_effect = {
				rename_capital = "Where the Ynn Widens"	
			}
		}

		add_country_modifier = {
			name = malacnar_faith_beyond
			duration = 9125
		}
	}
}
#The Embers of the Domandrod pt2
country_event = {
	id = flavor_malacnar.119
	title = flavor_malacnar.119.t
	desc = flavor_malacnar.119.d
	picture = COUNTRY_COLLAPSE_eventPicture
	
	is_triggered_only = yes
	trigger = {
		culture_group = eordan_ruinborn_elf
		capital_scope = { superregion = eordand_superregion }
	}
	
	option = {
		name = flavor_malacnar.119.a
		reduce_stability_or_adm_power = yes
		add_country_modifier = {
			name = malacnar_burnt_domandrod
			duration = -1
		}
		add_opinion = {
			who = FROM
			modifier = malacnar_burnt_down_our_forest
			years = 100
		}
	}
}
#Turn Companion to normal vassal
country_event = {
	id = flavor_malacnar.120
	title = flavor_malacnar.120.t
	desc = flavor_malacnar.120.d
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		is_subject_of_type = ynnic_iosahar
		is_companion = yes
		overlord = {
			NOT = { religion = ynn_river_worship }
			NOT = {
				any_subject_country = {
					has_country_flag = ynn_civil_war_iosahar
					has_country_flag = ynn_civil_war_religion
				}
			}
		}
	}
	
	option = {
		name = flavor_malacnar.120.a
		G32 = { country_event = { id = flavor_malacnar.110 } }
		clr_global_flag = G32_companions_active
	}
}
#Go to school
country_event = {
	id = flavor_malacnar.121
	title = flavor_malacnar.121.t
	desc = {
		trigger = {
			ynn_cannorian_thought = no
		}
	   desc = flavor_malacnar.121.d1
	}
	desc = {
		trigger = {
			ynn_cannorian_thought = yes
		}
	   desc = flavor_malacnar.121.d2
	}
	picture = UNIVERSITY_eventPicture
	
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
				random_owned_province = {
				limit = {
					is_capital = no
					has_owner_religion = yes
					is_reformation_center = no
					NOT = { has_province_modifier = religious_zeal_at_conv }
					NOT = { religion = corinite }
				}
				save_event_target_as = province_under_religious_influence
			}
		}
	}
	
	option = {
		name = flavor_malacnar.121.a
		trigger = {
			ynn_cannorian_thought = no
		}
		ai_chance = { factor = 1 }

		add_prestige = 5
	}
	
	option = {
		name = flavor_malacnar.121.b
		trigger = {
			ynn_cannorian_thought = yes
		}
		ai_chance = { factor = 1 }

		event_target:province_under_religious_influence = {
			change_religion = corinite
		}
		small_increase_of_human_tolerance_effect = yes
	}
}


country_event = {	#The Fate of Malacnar
	id = flavor_malacnar.200
	title = flavor_malacnar.200.t
	desc = flavor_malacnar.200.desc
	picture = CONQUEST_eventPicture

	fire_only_once = yes
	is_triggered_only = yes
	major = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	option = {
		name = flavor_malacnar.200.a	#Let us appoint a loyal elf to rule the reformed Lordship of Malacnar
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0.5
				G32 = {
					num_of_cities = 5
				}
			}
			modifier = {
				factor = 0
				G32 = {
					num_of_cities = 10
				}
			}
		}
		trigger = {
			NOT = {
				tag = G26
				was_tag = G26
			}
		}
		if = {		#you get back any core Malacnar had taken from you
			limit = { core_claim = FROM }
			FROM = {
				every_owned_province = {
					limit = { is_core = ROOT }
					cede_province = ROOT
					remove_core = G32
				}
			}
		}
		FROM = {
			kill_ruler = yes
			add_prestige = -25
			change_government = monarchy	#Reform Malacnar
			add_government_reform = feudalism_reform
		}
		every_known_country = {		#Upset claimants to Malacnar's territory
			limit = {
				core_claim = G32
				exists = yes
				NOT = { tag = ROOT }
			}
			country_event = { id = flavor_malacnar.202 days = 3 }
			add_opinion = {
				who = ROOT
				modifier = opinion_disappointed
			}
		}
	}
	
	option = {
		name = flavor_malacnar.200.b	#Let us split Malacnar into several loyal lordships
		trigger = {
			FROM = {
				any_owned_province = {
					NOT = { is_core = ROOT }
					any_core_country = { 
						NOT = { tag = G32 }
						exists = no
					}
				}
			}
			NOT = {
				tag = G26
				was_tag = G26
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 2
				G32 = {
					num_of_cities = 5
				}
			}
			modifier = {
				factor = 10
				G32 = {
					num_of_cities = 10
				}
			}
		}
		if = {		#you get back any core Malacnar had taken from you
			limit = { core_claim = FROM }
			FROM = {
				every_owned_province = {
					limit = { is_core = ROOT }
					cede_province = ROOT
					remove_core = G32
				}
			}
		}
		custom_tooltip = malacnar_restore_tooltip
		hidden_effect = {	#Release annexed countries
			FROM = {
				every_owned_province = {
					limit = {
						NOT = { area = malacnar_area }
						any_core_country = {
							NOT = { tag = G32 }
							exists = no
						}
					}
					random_core_country = {
						limit = {
							exists = no
						}
						FROM = {
							release = PREV
							# difficult to get right primary culture and sets religion later so exempt from using release_with_religion_and_culture
						}
						hidden_effect = {
							change_government = monarchy
							add_government_reform = feudalism_reform
							change_religion = ROOT
								
							add_opinion = {
								who = ROOT
								modifier = saved_us_from_warlord
							}
							every_core_province = {
								remove_core = G32
							}
						}
						country_event = { id = ynn_events.20 }
					}
				}
			}
		}
		FROM = {
			kill_ruler = yes
			add_prestige = -25
			change_government = monarchy	#Reform Malacnar
			add_government_reform = feudalism_reform
		}
		every_known_country = {		#Upset claimants to Malacnar's territory
			limit = {
				core_claim = G32
				exists = yes
				NOT = { tag = ROOT }
				NOT = { tag = FROM }
			}
			country_event = { id = flavor_malacnar.202 days = 3 }
			add_opinion = {
				who = ROOT
				modifier = opinion_disappointed
			}
		}
	}
	
	option = {
		name = flavor_malacnar.200.c	#Let us partition Malacnar between its neighbors
		trigger = { 
			G32 = { ai = yes } #Would be too punishing for a player
			NOT = {
				tag = G26
				was_tag = G26
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 2
				G32 = {
					num_of_cities = 5
				}
			}
			modifier = {
				factor = 10
				G32 = {
					num_of_cities = 10
				}
			}
		}
		if = {		#you get back any core Malacnar had taken from you
			limit = { core_claim = FROM }
			FROM = {
				every_owned_province = {
					limit = { is_core = ROOT }
					cede_province = ROOT
					remove_core = G32
				}
			}
		}
		
		custom_tooltip = malacnar_partition_tooltip
		hidden_effect = {
			G32 = {
				random_neighbor_country = {
					limit = {
						NOT = { tag = ROOT }
					}
					save_event_target_as = malacnar_partitioner
				}
			}
			G32 = {
				random_neighbor_country = {	#Prioritizes Ynn River Worshipers
					limit = {
						NOT = { tag = ROOT }
						religion_group = ynnic
					}
					save_event_target_as = malacnar_partitioner
				}
			}
			G32 = {
				random_known_country = {	#Prioritizes claimants
					limit = {
						NOT = { tag = ROOT }
						core_claim = FROM
					}
					save_event_target_as = malacnar_partitioner
				}
			}
			event_target:malacnar_partitioner = { 
				country_event = { id = flavor_malacnar.201 }
				set_country_flag = malacnar_partitioner_flag
			}
		}
	}
	
	option = {
		name = flavor_malacnar.200.d	#Let us annex Malacnar's lands into our demesne
		trigger = { 
			G32 = { ai = yes } #Would be too punishing for a player
			NOT = {
				tag = G26
				was_tag = G26
			}
		}	
		ai_chance = {
			factor = 2
			modifier = {
				factor = 0.5
				G32 = {
					num_of_cities = 5
				}
			}
			modifier = {
				factor = 0
				G32 = {
					num_of_cities = 10
				}
			}
		}
		if = {		#you get back any core Malacnar had taken from you
			limit = { core_claim = FROM }
			FROM = {
				every_owned_province = {
					limit = { is_core = ROOT }
					cede_province = ROOT
					remove_core = G32
				}
			}
		}
		malacnar_area = {	#you annex the Malacnar area
			limit = { owned_by = G32 }
			cede_province = ROOT
		}
		custom_tooltip = malacnar_annex_and_restore_tooltip
		hidden_effect = {	#Release annexed countries...
			FROM = {
				every_owned_province = {
					limit = {
						NOT = { area = malacnar_area }
						any_core_country = {
							NOT = { tag = G32 }
							exists = no
						}
					}
					random_core_country = {
						limit = {
							exists = no
						}
						FROM = {
							release = PREV
							# difficult to get right primary culture and sets religion later so exempt from using release_with_religion_and_culture
						}
						hidden_effect = {
							change_government = monarchy
							add_government_reform = feudalism_reform
							change_religion = ynn_river_worship
								
							add_opinion = {
								who = ROOT
								modifier = saved_us_from_warlord
							}
							every_core_province = {
								remove_core = G32
							}
						}
					}
				}
			}
		}
		hidden_effect = {	#...And let neighbours partition the rest
			if = {
				limit = {
					G32 = {
						any_owned_province = {
							NOT = { 
								is_core = ROOT 
								area = malacnar_area
							}
						}
					}
				}
				G32 = {
					random_neighbor_country = {
						limit = {
							NOT = { tag = ROOT }
						}
						save_event_target_as = malacnar_partitioner
					}
				}
				G32 = {
					random_neighbor_country = {	#Prioritizes Ynn River Worshipers
						limit = {
							NOT = { tag = ROOT }
							religion_group = ynnic
						}
						save_event_target_as = malacnar_partitioner
					}
				}
				G32 = {
					random_known_country = {	#Prioritizes claimants
						limit = {
							NOT = { tag = ROOT }
							core_claim = FROM
						}
						save_event_target_as = malacnar_partitioner
					}
				}
				event_target:malacnar_partitioner = { 
					country_event = { id = flavor_malacnar.201 }
					set_country_flag = malacnar_partitioner_flag
				}
			}
		}
		every_known_country = {		#Upset claimants to Malacnar area
			limit = {
				OR = {
					is_core = 1168
					is_core = 1169
					is_core = 2808
				}
				exists = yes
				NOT = { tag = ROOT }
				NOT = { tag = FROM }
			}
			country_event = { id = flavor_malacnar.202 days = 3 }
			add_opinion = {
				who = ROOT
				modifier = opinion_disappointed
			}
		}
	}
	
	option = {
		name = flavor_malacnar.200.e	#Let's put the Battleguards in charge, same as option A but removes Battleguards Mercs and makes Malacnar a march
		highlight = yes
		trigger = {
			any_hired_mercenary_company	= {
				template = merc_malacnar_battleguards
			}
		}
		ai_chance = {
			factor = 3
			modifier = {
				factor = 0.5
				G32 = {
					num_of_cities = 5
				}
			}
			modifier = {
				factor = 0
				G32 = {
					num_of_cities = 10
				}
			}
		}
		if = {		#you get back any core Malacnar had taken from you
			limit = { core_claim = FROM }
			FROM = {
				every_owned_province = {
					limit = { is_core = ROOT }
					cede_province = ROOT
					remove_core = G32
				}
			}
		}
		FROM = {
			kill_ruler = yes
			add_prestige = -25
			change_government = theocracy	#Reform Malacnar
			add_government_reform = secular_order_reform
			add_country_modifier = { #10% Morale, same as merc bonus
				name = G32_ruled_by_battleguards
				duration = -1
			}
		}
		create_subject = { #Make them a March
			subject_type = march
			subject = G32
		}
		random_hired_mercenary_company = { #Disband Battleguards as they take over Malacnar
			limit = {
				template = merc_malacnar_battleguards
			}
			disband_mercenary_company = THIS
		}
		custom_tooltip = ynn_malacnar_battleguards_lose_tt
		every_known_country = {		#Upset claimants to Malacnar's territory
			limit = {
				core_claim = G32
				exists = yes
				NOT = { tag = ROOT }
			}
			country_event = { id = flavor_malacnar.202 days = 3 }
			add_opinion = {
				who = ROOT
				modifier = opinion_disappointed
			}
		}
	}
	
	option = {
		name = flavor_malacnar.200.f	#Amacimst special option. Divide Malacnar, Let them keep Malacnar + Drevonbost, seize Amaceped.
		trigger = {
			OR = {
				tag = G26
				was_tag = G26
			}
		}	
		ai_chance = { factor = 1 }
		if = {		#you get back any core Malacnar had taken from you
			limit = { core_claim = FROM }
			FROM = {
				every_owned_province = {
					limit = { is_core = ROOT }
					cede_province = ROOT
					remove_core = G32
				}
			}
		}
		FROM = {	#you annex Amaceped, they keep the Malacnar area
			every_owned_province = {
				limit = {
					province_id = 1168
				}
				cede_province = ROOT
			}
			every_subject_country = {
				limit = {
					NOT = { tag = G25 }
				}
				release_iosahar = yes
			}
		}
		FROM = { #And become a proper Ynnic lordship again
			kill_ruler = yes
			add_prestige = -25
			change_government = monarchy	#Reform Malacnar
			add_government_reform = feudalism_reform
			set_country_flag = G32_amacimst_partition_keep_malacnar_flag
		}
		custom_tooltip = malacnar_restore_tooltip_G26
		hidden_effect = {	#Release annexed countries...
			FROM = {
				every_owned_province = {
					limit = {
						NOT = { area = malacnar_area }
						any_core_country = {
							NOT = { tag = G32 }
							exists = no
						}
					}
					random_core_country = {
						limit = {
							exists = no
						}
						FROM = {
							release = PREV
							# difficult to get right primary culture and sets religion later so exempt from using release_with_religion_and_culture
						}
						hidden_effect = {
							change_government = monarchy
							add_government_reform = feudalism_reform
							change_religion = ynn_river_worship
								
							add_opinion = {
								who = ROOT
								modifier = saved_us_from_warlord
							}
							every_core_province = {
								remove_core = G32
							}
						}
					}
				}
			}
		}
		hidden_effect = {	#...And let neighbours partition the rest
			G32 = {
				random_neighbor_country = {
					limit = {
						NOT = { tag = ROOT }
					}
					save_event_target_as = malacnar_partitioner
				}
			}
			G32 = {
				random_neighbor_country = {	#Prioritizes Ynn River Worshipers
					limit = {
						NOT = { tag = ROOT }
						religion_group = ynnic
					}
					save_event_target_as = malacnar_partitioner
				}
			}
			G32 = {
				random_known_country = {	#Prioritizes claimants
					limit = {
						NOT = { tag = ROOT }
						core_claim = FROM
					}
					save_event_target_as = malacnar_partitioner
				}
			}
			event_target:malacnar_partitioner = { 
				country_event = { id = flavor_malacnar.201 }
				set_country_flag = malacnar_partitioner_flag
			}
		}
		every_known_country = {		#Upset claimants to Malacnar area
			limit = {
				OR = {
					is_core = 1169
					is_core = 2808
				}
				exists = yes
				NOT = { tag = ROOT }
				NOT = { tag = FROM }
			}
			country_event = { id = flavor_malacnar.202 days = 3 }
			add_opinion = {
				who = ROOT
				modifier = opinion_disappointed
			}
		}
		#if = {
		#	limit = {
		#		1168 = {
		#			country_or_subject_holds = ROOT
		#		}
		#	}
		#	G30 = {
		#		country_event = { #Amacimst Seizes Amaceped!
		#			id = flavor_mocvare.1
		#			days = 3
		#		}
		#	}
		#}
	}
}

#Partitioning Malacnar
country_event = {
	id = flavor_malacnar.201
	title = flavor_malacnar.201.t
	desc = {
		trigger = {
			NOT = { G32 = { is_subject_of = ROOT } }
		}
	   desc = flavor_malacnar.201.d1
	}
	desc = {
		trigger = {
			G32 = { is_subject_of = ROOT }
		}
	   desc = flavor_malacnar.201.d2
	}
	picture = LAND_MILITARY_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		G32 = { exists = yes }
	}
	
	immediate = {
	}
	
	option = {
		name = flavor_malacnar.201.a
		
		if = {
			limit = {
				NOT = { G32 = { is_subject_of = ROOT } }
			}
			add_opinion = {
				who = FROM
				modifier = opinion_grateful
			}
			add_trust = {
				who = FROM
				value = 10
				mutual = yes
			}
		}
		
		if = {
			limit = {
				core_claim = G32
				NOT = { G32 = { is_subject_of = ROOT } }
			}
			ynn_superregion = {
				random_province = {
					limit = {
						owned_by = G32
						is_core = ROOT
					}
					cede_province = ROOT
					remove_core = G32
				}
				random_province = {	#Allows for an extra prov where it doesn't create conflict
					limit = {
						owned_by = G32
						NOT = { is_core = ROOT }
						all_neighbor_province = { 
							OR = {
								is_core = ROOT
								owned_by = ROOT
								owned_by = G32
								owner = { has_country_flag = malacnar_partitioner_flag }
							}
						}
						NOT = {
							AND = {
								province_id = 1169
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						NOT = {
							AND = {
								province_id = 2808
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
					}
					cede_province = ROOT
					if = {
						limit = {
							NOT = { area = malacnar_area }
						}
						remove_core = G32
					}
				}
			}
		}
		else_if = {
			limit = {
				NOT = { G32 = { is_subject_of = ROOT } }
			}
			random_owned_province = {
				limit = {
					any_neighbor_province = {
						NOT = {
							AND = {
								province_id = 1169
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						NOT = {
							AND = {
								province_id = 2808
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						owned_by = G32
						all_core_country = {
							OR = {
								tag = G32
								exists = no
							}
						}
					}
				}
				random_neighbor_province = {
					limit = {
						NOT = {
							AND = {
								province_id = 1169
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						NOT = {
							AND = {
								province_id = 2808
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						owned_by = G32
						all_core_country = {
							OR = {
								tag = G32
								exists = no
							}
						}
					}
					cede_province = ROOT
					if = {
						limit = {
							NOT = { area = malacnar_area }
						}
						remove_core = G32
					}
					random_neighbor_province = {	#Allows for an extra prov where it doesn't create conflict
						limit = {
							NOT = {
								AND = {
									province_id = 1169
									owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
								}
							}
							NOT = {
								AND = {
									province_id = 2808
									owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
								}
							}
							owned_by = G32
							all_neighbor_province = { 
								OR = {
									is_core = ROOT
									owned_by = ROOT
									owned_by = G32
									owner = { has_country_flag = malacnar_partitioner_flag }
								}
							}
						}
						cede_province = ROOT
						if = {
							limit = {
								NOT = { area = malacnar_area }
							}
							remove_core = G32
						}
					}
				}
			}
		}
		else = {
			ynn_superregion = {
				random_province = {
					limit = {
						owned_by = G32
						NOT = { is_core = ROOT }
						all_neighbor_province = { 
							OR = {
								is_core = ROOT
								owned_by = ROOT
								owned_by = G32
								owner = { has_country_flag = malacnar_partitioner_flag }
								is_state = no
							}
						}
						NOT = {
							AND = {
								province_id = 1169
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						NOT = {
							AND = {
								province_id = 2808
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
					}
					cede_province = ROOT
					if = {
						limit = {
							NOT = { area = malacnar_area }
						}
						remove_core = G32
					}
				}
				random_province = {
					limit = {
						owned_by = G32
						NOT = { is_core = ROOT }
						all_neighbor_province = { 
							OR = {
								is_core = ROOT
								owned_by = ROOT
								owned_by = G32
								owner = { has_country_flag = malacnar_partitioner_flag }
								is_state = no
							}
						}
						NOT = {
							AND = {
								province_id = 1169
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
						NOT = {
							AND = {
								province_id = 2808
								owner = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }
							}
						}
					}
					cede_province = ROOT
					if = {
						limit = {
							NOT = { area = malacnar_area }
						}
						remove_core = G32
					}
				}
			}
		}
		
		ai_chance = {
			factor = 1
		}
	}
	
	after = {
		FROM = { country_event = { id = flavor_malacnar.203 } }
	}
}

#The guy defeating Malacnar doesn't return our territories, and eats them for himself
country_event = {
	id = flavor_malacnar.202
	title = flavor_malacnar.202.t
	desc = flavor_malacnar.202.d
	picture = LAND_MILITARY_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_malacnar.202.a
		
		add_prestige = -10

		add_trust = {
			who = FROM
			value = -15
		}
		
		ai_chance = {
			factor = 1
		}
	}
}

#plays over and over until Malacnar is no more
country_event = {
	id = flavor_malacnar.203
	title = flavor_malacnar.203.t
	desc = flavor_malacnar.203.d
	picture = REFORM_eventPicture
	
	is_triggered_only = yes
	
	hidden = yes
	
	trigger = {
		G32 = {
			exists = yes
			OR = {
				NOT = { has_country_flag = G32_amacimst_partition_keep_malacnar_flag }	#Partitioning spares Malacnar area in Amacimst's version
				any_owned_province = {
					NOT = { area = malacnar_area }
				}
			}
		}
	}
	
	immediate = {
		ROOT = {
			save_event_target_as = malacnar_partitioner
		}
		G32 = {
			random_neighbor_country = {
				limit = {
					NOT = { tag = ROOT }
					NOT = { has_country_flag = malacnar_partitioner_flag }
				}
				save_event_target_as = malacnar_partitioner
			}
		}
		G32 = {
			random_neighbor_country = {	#Prioritizes Ynn River Worshipers
				limit = {
					NOT = { tag = ROOT }
					NOT = { has_country_flag = malacnar_partitioner_flag }
					religion_group = ynnic
				}
				save_event_target_as = malacnar_partitioner
			}
		}
		G32 = {
			random_known_country = {	#Prioritizes claimants
				limit = {
					NOT = { tag = ROOT }
					core_claim = G32
				}
				save_event_target_as = malacnar_partitioner
			}
		}
	}
	
	option = {
		name = flavor_malacnar.203.a
		
		event_target:malacnar_partitioner = { 
			country_event = { id = flavor_malacnar.201 }
			set_country_flag = malacnar_partitioner_flag
		}
		
		if = {
			limit = {
				event_target:malacnar_partitioner = { tag = ROOT }
			}
			every_known_country = {
				clr_country_flag = malacnar_partitioner_flag
			}
		}
		
		ai_chance = {
			factor = 1
		}
	}
}
