
namespace = diggy_expedition

#Setup Expeditions
country_event = {
	id = diggy_expedition.0
	title = diggy_expedition.0.t
	desc = diggy_expedition.0.d
	picture = CAVE_eventPicture
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		NOT = { has_global_flag = expedition_initalized }
	}
	
	immediate = {
		set_global_flag = expedition_initalized
	}
	
	after = {
	}
	
	#total: 65
	#new total: 56 + 12 = 68

	option = {
        name = diggy_expedition.0.a
        ai_chance = { factor = 100 }
		for = {
			amount = 22
			effect = "
				random_province = {
					limit = { region = west_dwarovar_region is_city = no }
					spawn_expedition = yes
				}
			"
		}
		for = {
			amount = 13
			effect = "
				random_province = {
					limit = { region = serpentreach_region is_city = no }
					spawn_expedition = yes
				}
			"
		}
		for = {
			amount = 13
			effect = "
				random_province = {
					limit = { region = middle_dwarovar_region is_city = no }
					spawn_expedition = yes
				}
			"
		}
		#excludes 4266 Hul-az-Krakazol for MT purposes
		for = {
			amount = 8
			effect = "
				random_province = {
					limit = { region = tree_of_stone_region is_city = no NOT = { province_id = 4266 } }
					spawn_expedition = yes
				}
			"
		}
		
		seed_dwarovkron = yes

		every_country = {
			set_variable = { ancientDwarvenKnowledge = 0 }
		}
	}
}

#Expeditions Menu
country_event = {
	id = diggy_expedition.1
	title = diggy_expedition.1.t
	desc = diggy_expedition.1.d
	picture = CAVE_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		hidden_effect = {
			if = {
				limit = { NOT = { has_saved_event_target = expedition1 } }
				define_expedition_target = yes
			}
		}
	}
	
	after = {
		hidden_effect = {
			every_owned_province = {
				limit = { has_province_flag = expedition_@ROOT }
				clr_province_flag = expedition_@ROOT
			}
		}
	}
	
	#Go Back
	option = {
        name = diggy_expedition.1.a
        ai_chance = { factor = 0 }
		hidden_effect = { clr_country_flag = debug_menu }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.b
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition1 }
		goto = expedition1
		custom_tooltip = diggy_expedition.1.tooltip1
		event_target:expedition1 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.c
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition2 }
		goto = expedition2
		custom_tooltip = diggy_expedition.1.tooltip2
		event_target:expedition2 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.e
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition3 }
		goto = expedition3
		custom_tooltip = diggy_expedition.1.tooltip3
		event_target:expedition3 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.f
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition4 }
		goto = expedition4
		custom_tooltip = diggy_expedition.1.tooltip4
		event_target:expedition4 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.g
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition5 }
		goto = expedition5
		custom_tooltip = diggy_expedition.1.tooltip5
		event_target:expedition5 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.h
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition6 }
		goto = expedition6
		custom_tooltip = diggy_expedition.1.tooltip6
		event_target:expedition6 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.i
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition7 }
		goto = expedition7
		custom_tooltip = diggy_expedition.1.tooltip7
		event_target:expedition7 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.j
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition8 }
		goto = expedition8
		custom_tooltip = diggy_expedition.1.tooltip8
		event_target:expedition8 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.k
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition9 }
		goto = expedition9
		custom_tooltip = diggy_expedition.1.tooltip9
		event_target:expedition9 = { province_event = { id = diggy_expedition.2 } }
	}
	
	#Expeditions
	option = {
        name = diggy_expedition.1.l
        ai_chance = { factor = 100 }
		trigger = { has_saved_event_target = expedition10 }
		goto = expedition10
		custom_tooltip = diggy_expedition.1.tooltip10
		event_target:expedition10 = { province_event = { id = diggy_expedition.2 } }
	}
}

#Province Expeditions Menu
province_event = {
	id = diggy_expedition.2
	title = diggy_expedition.2.t
	desc = diggy_expedition.2.d
	picture = CAVE_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		hidden_effect = {
			generate_expedition = { base_floor = 1 base_danger = 1 } #failsafe, should already have been generated by on_action
		}
	}
	
	after = {
	}
	
	#Go Back
	option = {
        name = diggy_expedition.2.a
        ai_chance = { factor = 0 }
		owner = { 
			hidden_effect = {
				every_owned_province = {
					limit = { has_province_flag = expedition_@ROOT }
					clr_province_flag = expedition_@ROOT
				}
			}
			country_event = { id = diggy_expedition.1 }
		}
	}
	
	#Launch the expedition
	option = {
        name = diggy_expedition.2.b
        ai_chance = { factor = 100 }
		custom_tooltip = prepare_expedition_tooltip
		hidden_effect = {
			set_province_flag = sent_expedition_@ROOT
			owner = { set_country_flag = expedition_happening }
			if = {
				limit = { owner = { ai = no } }
				generate_party_stats = yes
				province_event = { id = diggy_expedition.3 }
			}
			else = { owner = { clr_country_flag = debug_menu } }
		}
	}
}

#Province Expeditions Menu - Before Start
province_event = {
	id = diggy_expedition.3
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		has_province_flag = sent_expedition_@owner
	}
	
	immediate = {
		hidden_effect = {
			if = {
				limit = { NOT = { has_province_flag = generated_party_stats_@ROOT } }
				generate_party_stats = yes
			}
		}
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Prepare expedition
	option = {
        name = diggy_expedition.3.a
        ai_chance = { factor = 100 }
		if = {
			limit = { NOT = { has_province_flag = expedition_in_progress } }
			hidden_effect = { province_event = { id = diggy_expedition.4 } }
		}
		else = {
			custom_tooltip = expedition_in_progress_tooltip
			hidden_effect = { province_event = { id = diggy_expedition.1005 } }
		}
	}
	
	#Reset preparation
	option = {
        name = diggy_expedition.3.b
        ai_chance = { factor = 0 }
		refund_party_preparation = {
			manpower = yes
			morale = yes
			effectiveness = yes
			supplies = yes
			rewards = yes
		}
		hidden_effect = { province_event = { id = diggy_expedition.1005 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1005 } }
	}
	
	#Send Expedition
	option = {	#available
        name = diggy_expedition.3.c
		trigger = {
			check_variable = { partyManpower = 1 }
			check_variable = { partySupplies = 1 }
			NOT = { has_province_flag = expedition_in_progress }
		}
        ai_chance = { factor = 100 }
		if = {
			limit = { NOT = { check_variable = { partyRewards = 1 } } }
			custom_tooltip = no_rewards_tooltip
		}
		custom_tooltip = start_expedition_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = {
			owner = {
				clr_country_flag = dwarven_pantheon_expedition_dolurazan #Effectiveness
				clr_country_flag = dwarven_pantheon_expedition_derzobrazan
				clr_country_flag = dwarven_pantheon_expedition_bervinazan
				clr_country_flag = dwarven_pantheon_expedition_karazlov #Morale
				clr_country_flag = dwarven_pantheon_expedition_grimthar
				clr_country_flag = dwarven_pantheon_expedition_thyrfen #Supplies
				clr_country_flag = dwarven_pantheon_expedition_werdun
				clr_country_flag = dwarven_pantheon_expedition_lorgram #Manpower
				clr_country_flag = dwarven_pantheon_expedition_grobilazk
				clr_country_flag = gronstunad_supplied_expedition
			}
			set_province_flag = sent_expedition_@owner
			set_province_flag = expedition_in_progress
			
			
			if = { limit = { has_province_flag = explorable_dungeon }		#Launch custom dungeon instead of normal expedition
				province_event = { id = diggy_dungeons.2 days = 30 }
				province_event = { id = diggy_dungeons.3 }
			}
			else = {
				province_event = { id = diggy_expedition.2000 days = 30 }
				province_event = { id = diggy_expedition.1005 }
			}
			save_party_preparation = yes
		}
	}
	option = {	#unavailable
        name = diggy_expedition.3.cx
		trigger = {
			OR = {
				NOT = { check_variable = { partyManpower = 1 } }
				NOT = { check_variable = { partySupplies = 1 } }
				has_province_flag = expedition_in_progress
			}
		}
        ai_chance = { factor = 0 }
		if = { limit = { NOT = { check_variable = { partyManpower = 1 } } }
			custom_tooltip = not_enough_men_expedition_tooltip
		}
		if = { limit = { NOT = { check_variable = { partySupplies = 1 } } }
			custom_tooltip = not_enough_supplies_expedition_tooltip
		}
		if = { limit = { has_province_flag = expedition_in_progress }
			custom_tooltip = expedition_in_progress_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1005 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1005 } }
	}
	
	#Close
	option = {
        name = diggy_expedition.close
        ai_chance = { factor = 100 }
		hidden_effect = { owner = { clr_country_flag = debug_menu } }
	}
}

#Prepare the Expedition - Main
province_event = {
	id = diggy_expedition.4
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_2_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Send Manpower
	option = {
        name = diggy_expedition.4.b
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.5 } }
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
	}
	
	#Morale
	option = {
        name = diggy_expedition.4.e
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.7 } }
		custom_tooltip = morale_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
	}
	
	#Effectiveness
	option = {
        name = diggy_expedition.4.c
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.6 } }
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
	}
	
	#Supplies
	option = {
        name = diggy_expedition.4.a
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.8 } }
		custom_tooltip = supplies_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
	}
	
	#Rewards
	option = {
        name = diggy_expedition.4.f
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.9 } }
		custom_tooltip = rewards_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
	}
	
	#Go Back
	option = {
        name = diggy_expedition.goback
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.3 } }
	}
}

#Send Manpower
province_event = {
	id = diggy_expedition.5
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_MANPOWER_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Send one dude
	option = {	#available
        name = diggy_expedition.5.a
        ai_chance = { factor = 100 }
		trigger = {
			infantry_in_province = 1
			infantry_in_province = owner
			NOT = { check_variable = { partyManpower = 10000 } }
		}
		change_party_manpower = { add_expedition = 1 }
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	option = {	#unavailable
        name = diggy_expedition.5.ax
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partyManpower = 10000 }
				 NOT = { infantry_in_province = owner }
			}
		}
		if = { limit = { check_variable = { partyManpower = 10000 } }
			custom_tooltip = max_manpower_size_tooltip
		}
		if = { limit = { NOT = { infantry_in_province = owner } }
			custom_tooltip = no_infantry_in_province_tooltip
		}
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	
	#Send five dude
	option = {	#available
        name = diggy_expedition.5.b
        ai_chance = { factor = 100 }
		trigger = {
			infantry_in_province = 1
			infantry_in_province = owner
			NOT = { check_variable = { partyManpower = 10000 } }
		}
		change_party_manpower = { add_expedition = 5 }
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	option = {	#unavailable
        name = diggy_expedition.5.bx
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partyManpower = 10000 }
				 NOT = { infantry_in_province = owner }
			}
		}
		if = { limit = { check_variable = { partyManpower = 10000 } }
			custom_tooltip = max_manpower_size_tooltip
		}
		if = { limit = { NOT = { infantry_in_province = owner } }
			custom_tooltip = no_infantry_in_province_tooltip
		}
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	
	#Send ten dude
	option = {	#available
        name = diggy_expedition.5.c
        ai_chance = { factor = 100 }
		trigger = {
			infantry_in_province = 1
			infantry_in_province = owner
			NOT = { check_variable = { partyManpower = 10000 } }
		}
		change_party_manpower = { add_expedition = 10 }
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	option = {	#unavailable
        name = diggy_expedition.5.cx
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partyManpower = 10000 }
				 NOT = { infantry_in_province = owner }
			}
		}
		if = { limit = { check_variable = { partyManpower = 10000 } }
			custom_tooltip = max_manpower_size_tooltip
		}
		if = { limit = { NOT = { infantry_in_province = owner } }
			custom_tooltip = no_infantry_in_province_tooltip
		}
		custom_tooltip = manpower_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	
	#Reset Reward
	option = {
        name = diggy_expedition.reset
        ai_chance = { factor = 0 }
		refund_party_preparation = { manpower = yes }
		hidden_effect = { province_event = { id = diggy_expedition.1000 } }
	}
	
	#Go Back
	option = {
        name = diggy_expedition.goback
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.4 } }
	}
}

#Improve Effectiveness
province_event = {
	id = diggy_expedition.6
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_EFFECTIVENESS_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Train the troop
	option = {	#available
        name = diggy_expedition.6.a
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partyEffectiveness = 200 } }
			owner = { adm_power = 5 dip_power = 5 mil_power = 5 }
		}
		owner = {
			add_adm_power = -5
			add_dip_power = -5
			add_mil_power = -5
		}
		change_party_effectiveness = { add = 3 adm_cost = 5 dip_cost = 5 mil_cost = 5 add_tooltip = yes }
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	option = {	#unavailable
        name = diggy_expedition.6.ax
        ai_chance = { factor = 0 }
		trigger = {
			OR = {
				check_variable = { partyEffectiveness = 200 }
				owner = { NOT = { adm_power = 5 } }
				owner = { NOT = { dip_power = 5 } }
				owner = { NOT = { mil_power = 5 } }
			}
		}
		if = { limit = { check_variable = { partyEffectiveness = 200 } }
			custom_tooltip = max_effectiveness_tooltip
		}
		if = {
			limit = {
				OR = {
					owner = { NOT = { adm_power = 5 } }
					owner = { NOT = { dip_power = 5 } }
					owner = { NOT = { mil_power = 5 } }
				}
			}
			custom_tooltip = not_enough_mana_tooltip
		}
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	
	#Draft plan
	option = {	#available
        name = diggy_expedition.6.b
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partyEffectiveness = 200 } }
			owner = { adm_power = 15 dip_power = 15 mil_power = 15 }
		}
		owner = {
			add_adm_power = -15
			add_dip_power = -15
			add_mil_power = -15
		}
		change_party_effectiveness = { add = 9 adm_cost = 15 dip_cost = 15 mil_cost = 15 add_tooltip = yes }
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	option = {	#unavailable
        name = diggy_expedition.6.bx
        ai_chance = { factor = 0 }
		trigger = {
			OR = {
				check_variable = { partyEffectiveness = 200 }
				owner = { NOT = { adm_power = 15 } }
				owner = { NOT = { dip_power = 15 } }
				owner = { NOT = { mil_power = 15 } }
			}
		}
		if = { limit = { check_variable = { partyEffectiveness = 200 } }
			custom_tooltip = max_effectiveness_tooltip
		}
		if = {
			limit = { 
				OR = {
					owner = { NOT = { adm_power = 15 } }
					owner = { NOT = { dip_power = 15 } }
					owner = { NOT = { mil_power = 15 } }
				}
			}
			custom_tooltip = not_enough_mana_tooltip
		}
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	
	#Map the terrain
	option = {	#available
        name = diggy_expedition.6.c
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partyEffectiveness = 200 } }
			owner = { adm_power = 25 dip_power = 25 mil_power = 25 }
		}
		owner = {
			add_adm_power = -25
			add_dip_power = -25
			add_mil_power = -25
		}
		change_party_effectiveness = { add = 15 adm_cost = 25 dip_cost = 25 mil_cost = 25 add_tooltip = yes }
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	option = {	#unavailable
        name = diggy_expedition.6.cx
        ai_chance = { factor = 0 }
		trigger = {
			OR = {
				check_variable = { partyEffectiveness = 200 }
				owner = { NOT = { adm_power = 25 } }
				owner = { NOT = { dip_power = 25 } }
				owner = { NOT = { mil_power = 25 } }
			}
		}
		if = { limit = { check_variable = { partyEffectiveness = 200 } }
			custom_tooltip = max_effectiveness_tooltip
		}
		if = {
			limit = { 
				OR = {
					owner = { NOT = { adm_power = 25 } }
					owner = { NOT = { dip_power = 25 } }
					owner = { NOT = { mil_power = 25 } }
				}
			}
			custom_tooltip = not_enough_mana_tooltip
		}
		custom_tooltip = effectiveness_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	
	#Reset Reward
	option = {
        name = diggy_expedition.reset
        ai_chance = { factor = 0 }
		refund_party_preparation = { effectiveness = yes }
		hidden_effect = { province_event = { id = diggy_expedition.1001 } }
	}
	
	#Go Back
	option = {
        name = diggy_expedition.goback
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.4 } }
	}
}

#Improve Morale
province_event = {
	id = diggy_expedition.7
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_MORALE_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Organize a Banquet
	option = {	#available
        name = diggy_expedition.7.a
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partyMorale = 10 } }
			owner = { adm_power = 5 dip_power = 5 mil_power = 5 }
		}
		owner = {
			add_adm_power = -5
			add_dip_power = -5
			add_mil_power = -5
		}
		change_party_morale = { add = 0.5 adm_cost = 5 dip_cost = 5 mil_cost = 5 add_tooltip = yes }
		custom_tooltip = morale_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	option = {	#unavailable
        name = diggy_expedition.7.ax
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partyMorale = 10 }
				owner = { NOT = { adm_power = 5 } }
				owner = { NOT = { dip_power = 5 } }
				owner = { NOT = { mil_power = 5 } }
			}
		}
		if = { limit = { check_variable = { partyMorale = 10 } }
			custom_tooltip = max_morale_tooltip
		}
		if = {
			limit = { 
				OR = {
					owner = { NOT = { adm_power = 5 } }
					owner = { NOT = { dip_power = 5 } }
					owner = { NOT = { mil_power = 5 } }
				}
			}
			custom_tooltip = not_enough_mana_tooltip
		}
		custom_tooltip = morale_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	
	#Lot of Loves
	option = {	#available
        name = diggy_expedition.7.b
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partyMorale = 10 } }
			owner = { adm_power = 15 dip_power = 15 mil_power = 15 }
		}
		owner = {
			add_adm_power = -15
			add_dip_power = -15
			add_mil_power = -15
		}
		change_party_morale = { add = 1.5 adm_cost = 15 dip_cost = 15 mil_cost = 15 add_tooltip = yes }
		custom_tooltip = morale_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	option = {	#unavailable
        name = diggy_expedition.7.bx
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partyMorale = 10 }
				owner = { NOT = { adm_power = 15 } }
				owner = { NOT = { dip_power = 15 } }
				owner = { NOT = { mil_power = 15 } }
			}
		}
		if = { limit = { check_variable = { partyMorale = 10 } }
			custom_tooltip = max_morale_tooltip
		}
		if = {
			limit = { 
				OR = {
					owner = { NOT = { adm_power = 15 } }
					owner = { NOT = { dip_power = 15 } }
					owner = { NOT = { mil_power = 15 } }
				}
			}
			custom_tooltip = not_enough_mana_tooltip
		}
		custom_tooltip = morale_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	
	#Add upfront money bonuses
	option = {	#available
        name = diggy_expedition.7.c
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partyMorale = 10 } }
		}
		
		if = {
			limit = { check_variable = { partyMorale = 7 } }
			owner = { add_treasury = -1000 }
			change_party_morale = { add = 1.5 cash_cost = 1000 add_tooltip = yes }
		}
		else_if = {
			limit = { check_variable = { partyMorale = 5 } }
			owner = { add_treasury = -500 }
			change_party_morale = { add = 1.5 cash_cost = 500 add_tooltip = yes }
		}
		else = {
			owner = { add_treasury = -100 }
			change_party_morale = { add = 1.5 cash_cost = 100 add_tooltip = yes }
		}
		custom_tooltip = morale_desc_tooltip
		if = { 
			limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	option = {	#unavailable
        name = diggy_expedition.7.cx
        ai_chance = { factor = 100 }
		trigger = {
			check_variable = { partyMorale = 10 }
		}
		if = { limit = { check_variable = { partyMorale = 10 } }
			custom_tooltip = max_morale_tooltip
		}
		custom_tooltip = morale_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	
	#Reset Reward
	option = {
        name = diggy_expedition.reset
        ai_chance = { factor = 0 }
		refund_party_preparation = { morale = yes }
		hidden_effect = { province_event = { id = diggy_expedition.1002 } }
	}
	
	#Go Back
	option = {
        name = diggy_expedition.goback
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.4 } }
	}
}

#Improve Supplies
province_event = {
	id = diggy_expedition.8
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_SUPPLIES_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Prepare equipment
	option = {	#available
        name = diggy_expedition.8.a
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partySupplies = 100 } }
			owner = { mil_power = 10 }
		}
		owner = { add_mil_power = -10 }
		change_party_supplies = { add = 20 mil_cost = 10 add_tooltip = yes }
		custom_tooltip = supplies_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	option = {	#unavailable
        name = diggy_expedition.8.ax
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partySupplies = 100 }
				owner = { NOT = { mil_power = 10 } }
			}
		}
		if = { limit = { check_variable = { partySupplies = 100 } }
			custom_tooltip = max_supplies_tooltip
		}
		if = {
			limit = { owner = { NOT = { mil_power = 10 } } }
			custom_tooltip = not_enough_mil_power_tooltip
		}
		custom_tooltip = supplies_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	
	#Prepare Foods
	option = {	#available
        name = diggy_expedition.8.b
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partySupplies = 100 } }
			owner = { adm_power = 10 }
		}
		owner = { add_adm_power = -10 }
		change_party_supplies = { add = 20 adm_cost = 10 add_tooltip = yes }
		custom_tooltip = supplies_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	option = {	#unavailable
        name = diggy_expedition.8.bx
        ai_chance = { factor = 100 }
		trigger = {
			OR = {
				check_variable = { partySupplies = 100 }
				owner = { NOT = { adm_power = 10 } }
			}
		}
		if = { limit = { check_variable = { partySupplies = 100 } }
			custom_tooltip = max_supplies_tooltip
		}
		if = {
			limit = { owner = { NOT = { adm_power = 10 } } }
			custom_tooltip = not_enough_adm_power_tooltip
		}
		custom_tooltip = supplies_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	
	#Just give them money to buy it themselves
	option = {	#available
        name = diggy_expedition.8.c
        ai_chance = { factor = 100 }
		trigger = {
			NOT = { check_variable = { partySupplies = 100 } }
		}
		if = {
			limit = { check_variable = { partySupplies = 60 } }
			owner = { add_treasury = -200 }
			change_party_supplies = { add = 20 cash_cost = 200 add_tooltip = yes }
		}
		else = {
			owner = { add_treasury = -100 }
			change_party_supplies = { add = 20 cash_cost = 100 add_tooltip = yes }
		}
		custom_tooltip = supplies_desc_tooltip
		if = { 
			limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	option = {	#unavailable
        name = diggy_expedition.8.cx
        ai_chance = { factor = 100 }
		trigger = {
			check_variable = { partySupplies = 100 }
		}
		if = { limit = { check_variable = { partySupplies = 100 } }
			custom_tooltip = max_supplies_tooltip
		}
		custom_tooltip = supplies_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	
	#Reset Reward
	option = {
        name = diggy_expedition.reset
        ai_chance = { factor = 0 }
		refund_party_preparation = { supplies = yes }
		hidden_effect = { province_event = { id = diggy_expedition.1003 } }
	}
	
	#Go Back
	option = {
        name = diggy_expedition.goback
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.4 } }
	}
}

#Increase Rewards
province_event = {
	id = diggy_expedition.9
	title = diggy_expedition.3.t
	desc = diggy_expedition.3.d
	picture = DWARVEN_EXPEDITION_REWARDS_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		update_party_costs = yes
	}
	
	after = {
	}
	
	#Add 100
	option = {	#available
        name = diggy_expedition.9.a
        ai_chance = { factor = 100 }
		trigger = { NOT = { check_variable = { partyRewards = 2000 } } }
		change_party_rewards = { add_tooltip = yes add = 100 }
		custom_tooltip = rewards_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1004 } }
	}
	option = {	#unavailable
        name = diggy_expedition.9.ax
        ai_chance = { factor = 0 }
		trigger = { check_variable = { partyRewards = 2000 } }
		custom_tooltip = max_rewards_tooltip
		custom_tooltip = rewards_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1004 } }
	}
	
	#Add 500
	option = {	#available
        name = diggy_expedition.9.b
        ai_chance = { factor = 100 }
		trigger = { NOT = { check_variable = { partyRewards = 2000 } } }
		change_party_rewards = { add_tooltip = yes add = 500 }
		custom_tooltip = rewards_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1004 } }
	}
	option = {	#unavailable
        name = diggy_expedition.9.bx
        ai_chance = { factor = 0 }
		trigger = { check_variable = { partyRewards = 2000 } }
		custom_tooltip = max_rewards_tooltip
		custom_tooltip = rewards_desc_tooltip
		if = { limit = { owner = { has_country_flag = sent_first_expedition } }
			custom_tooltip = previous_expedition_preparation_tooltip
		}
		hidden_effect = { province_event = { id = diggy_expedition.1004 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1005 } }
	}
	
	#Empty option
	option = {
        name = diggy_expedition.empty
        ai_chance = { factor = 0 }
		hidden_effect = { province_event = { id = diggy_expedition.1004 } }
	}
	
	#Reset Reward
	option = {
        name = diggy_expedition.reset
        ai_chance = { factor = 0 }
		refund_party_preparation = { rewards = yes }
		hidden_effect = { province_event = { id = diggy_expedition.1004 } }
	}
	
	#Go Back
	option = {
        name = diggy_expedition.goback
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.4 } }
	}
}

#Province Expeditions Menu - During Exped
province_event = {
	id = diggy_expedition.10
	title = diggy_expedition.10.t
	desc = diggy_expedition.10.d
	picture = DWARVEN_EXPEDITION_ONGOING_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		has_province_flag = sent_expedition_@owner
	}
	
	immediate = {
		hidden_effect = {
			update_party_costs = yes
			owner = { set_country_flag = debug_menu }
		}
	}
	
	after = {
		hidden_effect = { owner = { clr_country_flag = debug_menu } }
	}
	
	#Refresh
	option = {
        name = diggy_expedition.10.a
        ai_chance = { factor = 100 }
		hidden_effect = { province_event = { id = diggy_expedition.1005 } }
	}
	
	#Close
	option = {
        name = diggy_expedition.close
        ai_chance = { factor = 100 }
	}
}

#Next Floor
province_event = {
	id = diggy_expedition.11
	title = diggy_expedition.11.t
	desc = diggy_expedition.11.d
	picture = FAT_LOOT_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		hidden_effect = {
			set_variable = { progressFloor = 0 }
			set_variable = { nbEncounters = 0 }
			set_variable = { temp_adk = 0 }
			if = {
				limit = { 
					owner = { NOT = { num_of_cities = 2 } }
					continent = serpentspine 
				}
				set_adk_effect = yes
			}
		}
	}
	
	after = {}
	
	#Go Deeper
	option = {
        name = diggy_expedition.11.a
        ai_chance = { factor = 100 }
		if = {
			limit = { check_variable = { dangerLevel = 5 } }
			owner = { add_prestige_excess_to_splendour_effect = { VAL = 5 } }
		}
		else_if = {
			limit = { check_variable = { dangerLevel = 4 } }
			owner = { add_prestige_excess_to_splendour_effect = { VAL = 4 } }
		}
		else_if = {
			limit = { check_variable = { dangerLevel = 3 } }
			owner = { add_prestige_excess_to_splendour_effect = { VAL = 3 } }
		}
		else_if = {
			limit = { check_variable = { dangerLevel = 2 } }
			owner = { add_prestige_excess_to_splendour_effect = { VAL = 2 } }
		}
		else = {
			owner = { add_prestige_excess_to_splendour_effect = { VAL = 1 } }
		}
		if = {
			limit = { check_variable = { temp_adk = 3 } }
			add_adk_effect = { add = 3 }
		}
		else_if = {
			limit = { check_variable = { temp_adk = 2 } }
			add_adk_effect = { add = 2 }
		}
		else_if = {
			limit = { check_variable = { temp_adk = 1 } }
			add_adk_effect = { add = 1 }
		}
		hidden_effect = { province_event = { id = diggy_expedition.2000 days = 30 } }
		hidden_effect = {
			add_loot_effect = yes
			clr_province_flag = encounter_happening
			clr_province_flag = forced_floor_encounter
		}
	}
}

#Expedition Return
province_event = {
	id = diggy_expedition.12
	title = diggy_expedition.12.t
	desc = diggy_expedition.12.d
	picture = MULTI_RACIAL_MERC_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
		hidden_effect = {
			clr_province_flag = sent_expedition_@owner #so progress stops
			add_loot_effect = yes
			subtract_variable = { which = partyLoot which = partyRewards }
			if = {
				limit = { check_variable = { partyLoot = 1 } }
				set_variable = { which = cashLoot which = partyLoot }
				set_variable = { which = manaLoot which = partyLoot }
				divide_variable = { cashLoot = 2 }
				divide_variable = { manaLoot = 2 }
				divide_variable = { manaLoot = 3 }
				
				divide_variable = { manaLoot = 1000 }
				multiply_variable = { manaLoot = 1000 }
				
				divide_variable = { cashLoot = 1000 }
				multiply_variable = { cashLoot = 1000 }
			}
			else = {
				set_variable = { which = badLoot which = partyLoot }
				multiply_variable = { badLoot = -1 }
			}
			if = {
				limit = { 
					has_terrain = cavern
					NOT = { has_special_expedition = yes }
				}
				if = {
					limit = {
						check_variable = { dangerLevel = 5 }
					}
					random = {
						chance = 30
						set_province_flag = special_cave
					}
				}
				else_if = {
					limit = {
						check_variable = { dangerLevel = 4 }
					}
					random = {
						chance = 25
						set_province_flag = special_cave
					}
				}
				else_if = {
					limit = {
						check_variable = { dangerLevel = 3 }
					}
					random = {
						chance = 20
						set_province_flag = special_cave
					}
				}
				else_if = {
					limit = {
						check_variable = { dangerLevel = 2 }
					}
					random = {
						chance = 15
						set_province_flag = special_cave
					}
				}
				else_if = {
					limit = {
						check_variable = { dangerLevel = 1 }
					}
					random = {
						chance = 10
						set_province_flag = special_cave
					}
				}
			}
			if = {
				limit = {
					OR = {
						owner = { tag = H88 }
						owner = { tag = H93 }
						owner = { tag = H94 }
					}
				}
				owner = { add_legitimacy = 15 }
			}

			#dungeon spawn roll
			province_event = { id = diggy_dungeons.0 }

			#Gronstunad event on expedition completion
			province_event = { id = flavour_gronstunad.280 }
		}
	}
	
	after = {
		hidden_effect = {
			set_variable = { badLoot = 0 }
			if = {
				limit = { has_province_flag = special_cave }
				save_event_target_as = special_cave_target
				owner = { country_event = { id = diggy.35 } }
			}
		}
	}
	
	# All to manpower
	option = {
        name = diggy_expedition.12.a
        ai_chance = { factor = 100 }
		trigger = { hidden_trigger = { check_variable = { partyLoot = 1 } } }
		special_reward_expedition = yes
		currency_effect_expedition = {  currency = treasury cash = yes addTo = owner }
		currency_effect_expedition = {  currency = adm_power mana = yes addTo = owner }
		currency_effect_expedition = {  currency = dip_power mana = yes addTo = owner }
		currency_effect_expedition = {  currency = mil_power mana = yes addTo = owner }
		hidden_effect = {
			while = {
				limit = { check_variable = { partyManpower = 1000 } }
				subtract_variable = { partyManpower = 1000 }
				owner = { add_manpower = 1 }
			}
		}
		custom_tooltip = back_to_manpower_tooltip
		custom_tooltip = base_expedition_loot_tooltip
		if = {
			limit = { check_variable = { ancientDwarvenKnowledge = 1 } }
			province_event = { id = diggy_expedition.14 }
		}
		else = { hidden_effect = { clear_expedition_effect = yes } }
	}
	
	# Infantry unit and manpower
	option = {
        name = diggy_expedition.12.b
        ai_chance = { factor = 100 }
		trigger = { hidden_trigger = { check_variable = { partyLoot = 1 } } }
		special_reward_expedition = yes
		hidden_effect = {
			while = {
				limit = { check_variable = { partyManpower = 1000 } }
				subtract_variable = { partyManpower = 1000 }
				owner = { infantry = PREV }
			}
			owner = { add_manpower = 1 }
		}
		currency_effect_expedition = {  currency = treasury cash = yes addTo = owner }
		currency_effect_expedition = {  currency = adm_power mana = yes addTo = owner }
		currency_effect_expedition = {  currency = dip_power mana = yes addTo = owner }
		currency_effect_expedition = {  currency = mil_power mana = yes addTo = owner }
		custom_tooltip = back_to_manpower_unit_tooltip
		custom_tooltip = base_expedition_loot_tooltip
		if = {
			limit = { check_variable = { ancientDwarvenKnowledge = 1 } }
			province_event = { id = diggy_expedition.14 }
		}
		else = { hidden_effect = { clear_expedition_effect = yes } }
	}
	
	# Pay them, back to manpower
	option = {
        name = diggy_expedition.12.c
        ai_chance = { factor = 100 }
		trigger = { hidden_trigger = { NOT = { check_variable = { partyLoot = 1 } } } }
		special_reward_expedition = yes
		hidden_effect = {
			while = {
				limit = { check_variable = { partyManpower = 1000 } }
				subtract_variable = { partyManpower = 1000 }
				owner = { add_manpower = 1 }
			}
		}
		custom_tooltip = pay_the_difference_tooltip
		currency_effect_expedition = { currency = treasury badLoot = yes takeFrom = owner }
		custom_tooltip = back_to_manpower_tooltip
		if = {
			limit = { check_variable = { ancientDwarvenKnowledge = 1 } }
			province_event = { id = diggy_expedition.14 }
		}
		else = { hidden_effect = { clear_expedition_effect = yes } }
	}
	
	# Pay them, back to the field
	option = {
        name = diggy_expedition.12.e
        ai_chance = { factor = 100 }
		trigger = { hidden_trigger = { NOT = { check_variable = { partyLoot = 1 } } } }
		special_reward_expedition = yes
		hidden_effect = {
			while = {
				limit = { check_variable = { partyManpower = 1000 } }
				subtract_variable = { partyManpower = 1000 }
				owner = { infantry = PREV }
			}
			owner = { add_manpower = 1 }
		}
		custom_tooltip = pay_the_difference_tooltip
		currency_effect_expedition = { currency = treasury badLoot = yes takeFrom = owner }
		custom_tooltip = back_to_manpower_unit_tooltip
		if = {
			limit = { check_variable = { ancientDwarvenKnowledge = 1 } }
			province_event = { id = diggy_expedition.14 }
		}
		else = { hidden_effect = { clear_expedition_effect = yes } }
	}
	
	# Fuck them
	option = {
        name = diggy_expedition.12.f
        ai_chance = { factor = 100 }
		trigger = { hidden_trigger = { NOT = { check_variable = { partyLoot = 1 } } } }
		special_reward_expedition = yes
		owner = { 
			add_country_modifier = {
				name = dwarovar_expedition_douche
				duration = 3650
			}
		}
		custom_tooltip = dont_pay_the_difference_tooltip
		if = {
			limit = { check_variable = { ancientDwarvenKnowledge = 1 } }
			province_event = { id = diggy_expedition.14 }
		}
		else = { hidden_effect = { clear_expedition_effect = yes } }
	}
}

#Expedition Dead
province_event = {
	id = diggy_expedition.13
	title = diggy_expedition.13.t
	desc = diggy_expedition.13.d
	picture = LOOMING_DEATH_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		has_province_flag = sent_expedition_@owner
		has_province_flag = expedition_in_progress
		NOT = { has_province_modifier = expedition_death_timer }
	}
	
	immediate = {
		hidden_effect = { clr_province_flag = sent_expedition_@owner } #so progress stops
	}
	
	after = {
	}
	
	#Damnation
	option = {
        name = diggy_expedition.13.a
        ai_chance = { factor = 100 }
		if = {
			limit = { check_variable = { dangerLevel = 5 } }
			owner = { add_prestige = -10 }
		}
		else_if = {
			limit = { check_variable = { dangerLevel = 4 } }
			owner = { add_prestige = -15 }
		}
		else_if = {
			limit = { check_variable = { dangerLevel = 3 } }
			owner = { add_prestige = -20 }
		}
		else_if = {
			limit = { check_variable = { dangerLevel = 2 } }
			owner = { add_prestige = -25 }
		}
		else = {
			owner = { add_prestige = -30 }
		}
		owner = {
			random = {
				chance = 50
				add_stability = -1
			}
		}
		custom_tooltip = expedition_dead_tooltip
		hidden_effect = { expedition_dead_effect = yes }
	}
}

#What to do with ADK
province_event = {
	id = diggy_expedition.14
	title = diggy_expedition.14.t
	desc = diggy_expedition.14.d
	picture = MULTI_RACIAL_MERC_eventPicture
	goto = ROOT
	is_triggered_only = yes
	
	trigger = {
		always = yes
	}
	
	immediate = { }
	
	after = { clear_expedition_effect = yes }

	#store it
	option = {
        name = diggy_expedition.14.a
        ai_chance = { factor = 100 }
		reward_adk_effect = { store = yes }
	}

	#spend it
	option = {
        name = diggy_expedition.14.b
        ai_chance = { factor = 100 }
		reward_adk_effect = { spend = yes }
	}
}

################################################
######   AI, Debugs, Background events    ######
################################################
#Recursive
province_event = {
	id = diggy_expedition.1000
	title = diggy_expedition.1000.t
	desc = diggy_expedition.1000.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.1000.a
        ai_chance = { factor = 100 }
		province_event = { id = diggy_expedition.5 }
	}
}

province_event = {
	id = diggy_expedition.1001
	title = diggy_expedition.1001.t
	desc = diggy_expedition.1001.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.1001.a
        ai_chance = { factor = 100 }
		province_event = { id = diggy_expedition.6 }
	}
}

province_event = {
	id = diggy_expedition.1002
	title = diggy_expedition.1002.t
	desc = diggy_expedition.1002.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.1002.a
        ai_chance = { factor = 100 }
		province_event = { id = diggy_expedition.7 }
	}
}

province_event = {
	id = diggy_expedition.1003
	title = diggy_expedition.1003.t
	desc = diggy_expedition.1003.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.1003.a
        ai_chance = { factor = 100 }
		province_event = { id = diggy_expedition.8 }
	}
}

province_event = {
	id = diggy_expedition.1004
	title = diggy_expedition.1004.t
	desc = diggy_expedition.1004.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.1004.a
        ai_chance = { factor = 100 }
		province_event = { id = diggy_expedition.9 }
	}
}

province_event = {
	id = diggy_expedition.1005
	title = diggy_expedition.1005.t
	desc = diggy_expedition.1005.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.1005.a
        ai_chance = { factor = 100 }
		if = {
			limit = { has_province_flag = expedition_in_progress }
			hidden_effect = { province_event = { id = diggy_expedition.10 } }
		}
		else = {
			hidden_effect = { province_event = { id = diggy_expedition.3 } }
		}
	}
}

#Ai prep
province_event = {
	id = diggy_expedition.1500
	title = diggy_expedition.1500.t
	desc = diggy_expedition.1500.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		always = yes
	}
	
	option = {
        name = diggy_expedition.1500.a
        ai_chance = { factor = 100 }
		generate_ai_party = yes
		set_province_flag = sent_expedition_@owner
		set_province_flag = expedition_in_progress
		province_event = { id = diggy_expedition.2000 days = 30 }
		owner = { clr_country_flag = debug_menu }
	}
}

#####################
### Progress Loop ###
#####################

province_event = {
	id = diggy_expedition.2000
	title = diggy_expedition.2000.t
	desc = diggy_expedition.2000.d
	picture = CAVE_eventPicture
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		has_province_flag = sent_expedition_@owner
		NOT = { has_province_modifier = expedition_death_timer }
	}
	
	immediate = {
	}
	
	after = {
	}
	
	option = {
        name = diggy_expedition.2000.a
        ai_chance = { factor = 100 }
		progress_advancement = yes
		if = {
			limit = { 
				NOT = { check_variable = { progressFloor = 100 } } 
				check_variable = { partyManpower = 1 } 
			}
			if = {
				limit = { 
					check_variable = { progressFloor = 50 } 			# 100 - progressFloor must be higher than the max addProgress value in the progress_advancement scripted effect (currently 14)
					NOT = { check_variable = { nbEncounters = 1 } } 
					NOT = { has_province_flag = forced_floor_encounter } # Force an encounter at 90% if you didn't get at least one yet
					NOT = { has_province_flag = encounter_happening }
				} 
				set_province_flag = forced_floor_encounter
				change_variable = { nbEncounters = 1 }
				set_province_flag = encounter_happening
				launch_encounter = yes
			}
			else_if = {
				limit = { 
					NOT = { check_variable = { nbEncounters = 3 } } #Max 3 encounters per floors
					NOT = { has_province_flag = encounter_happening } 
				} 
				random_list = {
					10 = {
						modifier = { factor = 1.4 check_variable = { dangerLevel = 2 } }
						modifier = { factor = 1.4 check_variable = { dangerLevel = 3 } }
						modifier = { factor = 1.4 check_variable = { dangerLevel = 4 } }
						modifier = { factor = 1.4 check_variable = { dangerLevel = 5 } }
						modifier = { factor = 1.4 owner = { NOT = { num_of_cities = 2 } } }
						change_variable = { nbEncounters = 1 }
						set_province_flag = encounter_happening
						launch_encounter = yes
					}
					90 = { province_event = { id = diggy_expedition.2000 days = 30 } } #Keep advancing
				}
			}
			else_if = {
				limit = { has_province_flag = encounter_happening }
				clr_province_flag = encounter_happening
				province_event = { id = diggy_expedition.2000 days = 30 } #Keep advancing
			}
			else = {
				province_event = { id = diggy_expedition.2000 days = 30 } #Keep advancing
			}
		}
		else_if = {
			limit = { NOT = { check_variable = { partyManpower = 1 } } } #No more soldiers, you ded
			province_event = { id = diggy_expedition.13 }
		}
		else = {
			change_variable = { clearedFloor = 1 }
			if = {
				limit = { NOT = { is_variable_equal = { which = nbFloor which = clearedFloor } } }
				province_event = { id = diggy_expedition.11 }		#Next Floor
			}
			else = {
				province_event = { id = diggy_expedition.12 }		#Expedition Return
			}
		}
	}
}
