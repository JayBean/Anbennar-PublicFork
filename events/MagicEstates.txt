
namespace = magic_estate

#Magic Menu
country_event = {
	id = magic_estate.1
	title = magic_estate.1.t
	desc = magic_estate.1.d
	picture = SPELL_MENU_eventPicture
	
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = { 
			count_provinces_with_farm_goods_effect = {
				which = amount_of_farm_good_provinces
			}
			count_provinces_owned_by_country_effect = {
				which = amount_of_owned_provinces
			}
			divide_variable = {
				which = amount_of_farm_good_provinces
				which = amount_of_owned_provinces
			}
			
			count_provinces_broad_ward_effect = {
				which = amount_of_broad_ward_provinces
			}
			count_provinces_narrow_ward_effect = {
				which = amount_of_narrow_ward_provinces
			}
			count_provinces_owned_by_country_effect = {
				which = amount_of_owned_provinces
			}
			divide_variable = {
				which = amount_of_broad_ward_provinces
				which = amount_of_owned_provinces
			}
			divide_variable = {
				which = amount_of_narrow_ward_provinces
				which = amount_of_owned_provinces
			}
			# Use a ratio of farm_good_provinces to total provinces to determine pricing. Years of income already should scale reasonably, and dip power offsets overall gain. 
		
			if = {
				limit = { NOT = { has_estate_privilege = estate_mages_cast_spells } }
				add_country_modifier = {
					name = magic_cooldown
					duration = 3650
				}
			}
		}
	}
	
	#Go back
	option = {	
		name = magic_siege.1.z	
		ai_chance = {
			factor = 5
		}
		highlight = yes
		if = {
			limit = { NOT = { has_estate_privilege = estate_mages_cast_spells } }
			remove_country_modifier = magic_cooldown
		}
		if = { # Causes crashes on Linux
			limit = { ai = no }
			remove_estate_privilege = estate_mages_cast_spells 
		}
		else = {
			set_country_flag = revoke_mage_estate_spells
		}
	}
	
	#Host Magical Feast
	option = {
		name = magic_estate.1.b
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				personality = ai_diplomat
			}
		}
		add_years_of_income = -0.5
		
		#Effect
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			add_country_modifier = {
				name = magic_estate_magnificent_feast_3
				duration = 3650
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			add_country_modifier = {
				name = magic_estate_magnificent_feast_2
				duration = 3650
			}
		}
		else = {
			add_country_modifier = {
				name = magic_estate_magnificent_feast_1
				duration = 3650
			}
		}
		
		custom_tooltip = magic_feast_desc_tt
	}
	
	#Encourage Plant Growth
	option = {	#Available
		name = magic_estate.1.c
		trigger = {
			any_owned_province = { plant_growth_target = yes }
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				personality = ai_capitalist
			}
			modifier = {
				factor = 0
				check_variable = { which = amount_of_owned_provinces value = 100 }
			}
		}
		
		if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 1 } }
			add_dip_power = -100
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.9 } }
			add_dip_power = -90
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.8 } }
			add_dip_power = -80
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.7 } }
			add_dip_power = -70
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.6 } }
			add_dip_power = -60
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.5 } }
			add_dip_power = -50
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.4 } }
			add_dip_power = -40
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.3 } }
			add_dip_power = -30
		}
		else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.2 } }
			add_dip_power = -20
		}
		else = {
			add_dip_power = -10
		}
		
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			custom_tooltip = plant_growth_3_tooltip
			hidden_effect = {
				every_owned_province = {
					limit = {  plant_growth_target = yes }
					add_province_modifier = {
						name = magic_realm_transmutation_plant_growth_3
						duration = 3650
					}
				}
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			custom_tooltip = plant_growth_2_tooltip
			hidden_effect = {
				every_owned_province = {
					limit = { plant_growth_target = yes }
					add_province_modifier = {
						name = magic_realm_transmutation_plant_growth_2
						duration = 3650
					}
				}
			}
		}
		else = {
			custom_tooltip = plant_growth_1_tooltip
			hidden_effect = {
				every_owned_province = {
					limit = {  plant_growth_target = yes }
					add_province_modifier = {
						name = magic_realm_transmutation_plant_growth_1
						duration = 3650
					}
				}
			}
		}
		
		custom_tooltip = plant_growth_devastation_tooltip
		hidden_effect = { country_event = { id = magic_estate.100 } } #Devastation ticks up
		
		custom_tooltip = magic_plant_growth_desc_tt
	}
	option = {	#Unavailable
		name = magic_estate.1.cx
		trigger = {
			ai = no
			NOT = { any_owned_province = { plant_growth_target = yes } }
		}
		
		custom_tooltip = magic_need_valid_target_tt
		hidden_effect = { country_event = { id = magic_estate.2 } }
		custom_tooltip = magic_effect_separator_tt
		
		tooltip = {
			if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 1 } }
				add_dip_power = -100
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.9 } }
				add_dip_power = -90
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.8 } }
				add_dip_power = -80
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.7 } }
				add_dip_power = -70
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.6 } }
				add_dip_power = -60
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.5 } }
				add_dip_power = -50
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.4 } }
				add_dip_power = -40
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.3 } }
				add_dip_power = -30
			}
			else_if = { limit = { check_variable = { which = amount_of_farm_good_provinces value = 0.2 } }
				add_dip_power = -20
			}
			else = {
				add_dip_power = -10
			}
			
			if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
				custom_tooltip = plant_growth_3_tooltip
				hidden_effect = {
					every_owned_province = {
						limit = {  plant_growth_target = yes }
						add_province_modifier = {
							name = magic_realm_transmutation_plant_growth_3
							duration = 3650
						}
					}
				}
			}
			else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
				custom_tooltip = plant_growth_2_tooltip
				hidden_effect = {
					every_owned_province = {
						limit = { plant_growth_target = yes }
						add_province_modifier = {
							name = magic_realm_transmutation_plant_growth_2
							duration = 3650
						}
					}
				}
			}
			else = {
				custom_tooltip = plant_growth_1_tooltip
				hidden_effect = {
					every_owned_province = {
						limit = {  plant_growth_target = yes }
						add_province_modifier = {
							name = magic_realm_transmutation_plant_growth_1
							duration = 3650
						}
					}
				}
			}
		}
		custom_tooltip = plant_growth_devastation_tooltip
		
		custom_tooltip = magic_plant_growth_desc_tt
	}
	
	#Scrying Rivals
	option = {	#Available
		name = magic_estate.1.dd
		trigger = {
			any_rival_country  = { exists = yes }
		}
		ai_chance = {
			factor = 50
		}
		add_years_of_income = -0.5
		add_adm_power = -30	
		add_dip_power = -30
		
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			add_country_modifier = {
				name = magic_estate_scrying_rivals_3
				duration = 3650	#10 years
			}
			every_rival_country = {
				remove_fow = 120
				add_spy_network_from = { who = ROOT value = 30 }
				ROOT = { add_spy_network_from = { who = PREV value = -30 } }
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			add_country_modifier = {
				name = magic_estate_scrying_rivals_2
				duration = 3650	#5 years
			}
			every_rival_country = {
				remove_fow = 120
				add_spy_network_from = { who = ROOT value = 20 }
				add_spy_network_in = { who = ROOT value = -20 }
			}
		}
		else = {
			add_country_modifier = {
				name = magic_estate_scrying_rivals_1
				duration = 3650
			}
			every_rival_country = {
				remove_fow = 120
				add_spy_network_from = { who = ROOT value = 10 }
				add_spy_network_in = { who = ROOT value = -10 }
			}
		}
	}
	option = {	#Unavailable
		name = magic_estate.1.ddx
		trigger = {
			ai = no
			NOT = { any_rival_country  = { exists = yes } }
		}
		
		custom_tooltip = magic_need_valid_target_tt
		hidden_effect = { country_event = { id = magic_estate.2 } }
		custom_tooltip = magic_effect_separator_tt
		
		tooltip = {
			add_years_of_income = -0.5
			add_adm_power = -30	
			add_dip_power = -30
			
			if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
				add_country_modifier = {
					name = magic_estate_scrying_rivals_3
					duration = 3650	#10 years
				}
				every_rival_country = {
					remove_fow = 120
					add_spy_network_from = { who = ROOT value = 30 }
					ROOT = { add_spy_network_from = { who = PREV value = -30 } }
				}
			}
			else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
				add_country_modifier = {
					name = magic_estate_scrying_rivals_2
					duration = 3650	#5 years
				}
				every_rival_country = {
					remove_fow = 120
					add_spy_network_from = { who = ROOT value = 20 }
					add_spy_network_in = { who = ROOT value = -20 }
				}
			}
			else = {
				add_country_modifier = {
					name = magic_estate_scrying_rivals_1
					duration = 3650
				}
				every_rival_country = {
					remove_fow = 120
					add_spy_network_from = { who = ROOT value = 10 }
					add_spy_network_in = { who = ROOT value = -10 }
				}
			}
		}
		
		custom_tooltip = magic_scrying_desc_tt
	}
	
	#Scrying Neighbours
	option = {
		name = magic_estate.1.e
		trigger = {
			any_country = { is_neighbor_of = ROOT }
		}
		ai_chance = {
			factor = 50
		}
		if = { limit = { neighbor_is_ahead_in_institution = yes }
			add_years_of_income = -1.5
			add_adm_power = -60	
		}
		else = {
			add_years_of_income = -0.5
			add_adm_power = -60	
		}
		
		every_country = { limit = { is_neighbor_of  = ROOT }
			remove_fow = 120
		}	
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			add_country_modifier = {
				name = magic_estate_scrying_neighbours_3
				duration = 3650	#10 years
			}
			if = { limit = { neighbor_is_ahead_in_institution = yes }
				capital_scope = {
					area = {
						limit = { owned_by = ROOT }
						add_province_modifier = {
							name = magic_estate_scrying_stealing_institution_3
							duration = 3650
						}
					}
				}
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			add_country_modifier = {
				name = magic_estate_scrying_neighbours_2
				duration = 3650	#5 years
			}
			if = { limit = { neighbor_is_ahead_in_institution = yes }
				capital_scope = {
					area = {
						limit = { owned_by = ROOT }
						add_province_modifier = {
							name = magic_estate_scrying_stealing_institution_2
							duration = 3650
						}
					}
				}
			}
		}
		else = {
			add_country_modifier = {
				name = magic_estate_scrying_neighbours_1
				duration = 3650
			}
			if = { limit = { neighbor_is_ahead_in_institution = yes }
				capital_scope = {
					area = {
						limit = { owned_by = ROOT }
						add_province_modifier = {
							name = magic_estate_scrying_stealing_institution_1
							duration = 3650
						}
					}
				}
			}
		}
		
		custom_tooltip = magic_scrying_desc_tt
	}
	
	#Scrying internal dissidents
	option = {
		name = magic_estate.1.f
		ai_chance = {
			factor = 50
		}
		add_years_of_income = -0.5
		add_adm_power = -60	
		
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			add_country_modifier = {
				name = magic_estate_scrying_internal_dissidents_3
				duration = 3650	#10 years
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			add_country_modifier = {
				name = magic_estate_scrying_internal_dissidents_2
				duration = 3650	#5 years
			}
		}
		else = {
			add_country_modifier = {
				name = magic_estate_scrying_internal_dissidents_1
				duration = 3650
			}
		}
		
		custom_tooltip = magic_scrying_desc_tt
	}
	
	#Scry to aid the war effort
	option = {	#Available
		name = magic_estate.1.g
		trigger = {
			is_at_war = yes
		}
		ai_chance = {
			factor = 50
		}
		if = {
			limit = {
				has_country_flag = command_enslaved_the_oracle_flag
			}
			add_years_of_income = -0.5
			add_adm_power = -15	
			add_mil_power = -15
		}
		else = {
			add_years_of_income = -1
			add_adm_power = -30	
			add_mil_power = -30
		}
	
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			add_country_modifier = {
				name = magic_estate_scrying_military_intelligence_3
				duration = 3650	#10 years
			}
			every_country = {
				limit = { war_with = ROOT }
				remove_fow = 120
			}
		}
		else_if = { limit = { OR = { estate_influence = { estate = estate_mages influence = 33 } has_country_flag = command_enslaved_the_oracle_flag } }
			add_country_modifier = {
				name = magic_estate_scrying_military_intelligence_2
				duration = 1825	#5 years
			}
			every_country = {
				limit = { war_with = ROOT }
				remove_fow = 120
			}
		}
		else = {
			add_country_modifier = {
				name = magic_estate_scrying_military_intelligence_1
				duration = 365
			}
			every_country = {
				limit = { war_with = ROOT }
				remove_fow = 120
			}
		}
		
		custom_tooltip = magic_scrying_desc_tt
	}
	option = {	#Unavailable
		name = magic_estate.1.gx
		trigger = {
			ai = no
			is_at_war = no
		}
		
		custom_tooltip = magic_need_valid_target_tt
		hidden_effect = { country_event = { id = magic_estate.2 } }
		custom_tooltip = magic_effect_separator_tt
		
		tooltip = {
			add_years_of_income = -1
			add_adm_power = -30	
			add_mil_power = -30
		
			if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
				add_country_modifier = {
					name = magic_estate_scrying_military_intelligence_3
					duration = 3650	#10 years
				}
				every_country = {
					limit = { war_with = ROOT }
					remove_fow = 120
				}
			}
			else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
				add_country_modifier = {
					name = magic_estate_scrying_military_intelligence_2
					duration = 1825	#5 years
				}
				every_country = {
					limit = { war_with = ROOT }
					remove_fow = 120
				}
			}
			else = {
				add_country_modifier = {
					name = magic_estate_scrying_military_intelligence_1
					duration = 365
				}
				every_country = {
					limit = { war_with = ROOT }
					remove_fow = 120
				}
			}
		}
		
		custom_tooltip = magic_scrying_desc_tt
	}
	
	#Aid Constructions
	option = {
		name = magic_estate.1.h
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				any_owned_province = {
					construction_progress = 0.1
				}
			}
			modifier = {
				factor = 0.25
				years_of_income = 0.5
			}
		}
		add_years_of_income = -0.5
		
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			add_country_modifier = {
				name = magic_estate_aiding_construction_3
				duration = 3650
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			add_country_modifier = {
				name = magic_estate_aiding_construction_2
				duration = 3650
			}
		}
		else = {
			add_country_modifier = {
				name = magic_estate_aiding_construction_1
				duration = 3650
			}
		}
		
		custom_tooltip = magic_construction_desc_tt
	}
	
	#Broad Ward
	option = {	
		name = magic_estate.1.i
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				is_at_war = yes
			}
			modifier = {
				factor = 2
				personality = ai_capitalist
			}
		}
		if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.9 } }
			add_mil_power = -100
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.8 } }
			add_mil_power = -90
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.7 } }
			add_mil_power = -80
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.6 } }
			add_mil_power = -70
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.5 } }
			add_mil_power = -60
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.4 } }
			add_mil_power = -50
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.3 } }
			add_mil_power = -40
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.2 } }
			add_mil_power = -30
		}
		else_if = { limit = { check_variable = { which = amount_of_broad_ward_provinces value = 0.1 } }
			add_mil_power = -20
		}
		else = {
			add_mil_power = -10
		}
		
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			every_owned_province = {
				limit = {
					has_no_ward_province_modifiers = yes
					is_city = yes
					OR = {
						fort_level = 2
						is_capital = yes
					}
				}
				add_province_modifier = {
					name = magic_estate_broad_ward_3
					duration = 3650
				}
				#Kheionai windward boost
				if = {
					limit = {
						region = alecand_region
					}
					add_temporary_windward_level = {
						level = 1
						length = 3650
					}
				}
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			every_owned_province = {
				limit = {
					has_no_ward_province_modifiers = yes
					is_city = yes
					OR = {
						fort_level = 2
						is_capital = yes
					}
				}
				add_province_modifier = {
					name = magic_estate_broad_ward_2
					duration = 3650
				}
				#Kheionai windward boost
				if = {
					limit = {
						region = alecand_region
					}
					add_temporary_windward_level = {
						level = 1
						length = 3650
					}
				}
			}
		}
		else = {
			every_owned_province = {
				limit = {
					has_no_ward_province_modifiers = yes
					is_city = yes
					OR = {
						fort_level = 2
						is_capital = yes
					}
				}
				add_province_modifier = {
					name = magic_estate_broad_ward_1
					duration = 3650
				}
				#Kheionai windward boost
				if = {
					limit = {
						region = alecand_region
					}
					add_temporary_windward_level = {
						level = 1
						length = 3650
					}
				}
			}
		}
		
		custom_tooltip = magic_ward_desc_tt
	}
	
	#Narrow Ward
	option = {	
		name = magic_estate.1.j
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				is_at_war = yes
			}
			modifier = {
				factor = 2
				personality = ai_capitalist
			}
		}
		if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.9 } }
			add_mil_power = -200
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.8 } }
			add_mil_power = -180
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.7 } }
			add_mil_power = -160
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.6 } }
			add_mil_power = -140
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.5 } }
			add_mil_power = -120
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.4 } }
			add_mil_power = -100
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.3 } }
			add_mil_power = -80
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.2 } }
			add_mil_power = -60
		}
		else_if = { limit = { check_variable = { which = amount_of_narrow_ward_provinces value = 0.1 } }
			add_mil_power = -40
		}
		else = {
			add_mil_power = -20
		}
		if = { limit = { estate_influence = { estate = estate_mages influence = 66 } }
			every_owned_province = {
				limit = {
					has_no_ward_province_modifiers = yes
					is_city = yes
					OR = {
						AND = {
							has_building = ramparts
							fort_level = 2
						}
						is_capital = yes
					}
				}
				add_province_modifier = {
					name = magic_estate_ward_3
					duration = 3650
				}
				#Kheionai windward boost
				if = {
					limit = {
						region = alecand_region
					}
					add_temporary_windward_level = {
						level = 2
						length = 3650
					}
				}
			}
		}
		else_if = { limit = { estate_influence = { estate = estate_mages influence = 33 } }
			every_owned_province = {
				limit = {
					has_no_ward_province_modifiers = yes
					is_city = yes
					OR = {
						AND = {
							has_building = ramparts
							fort_level = 2
						}
						is_capital = yes
					}
				}
				add_province_modifier = {
					name = magic_estate_ward_2
					duration = 3650
				}
				#Kheionai windward boost
				if = {
					limit = {
						region = alecand_region
					}
					add_temporary_windward_level = {
						level = 2
						length = 3650
					}
				}
			}
		}
		else = {
			every_owned_province = {
				limit = {
					has_no_ward_province_modifiers = yes
					is_city = yes
					OR = {
						AND = {
							has_building = ramparts
							fort_level = 2
						}
						is_capital = yes
					}
				}
				add_province_modifier = {
					name = magic_estate_ward_1
					duration = 3650
				}
				#Kheionai windward boost
				if = {
					limit = {
						region = alecand_region
					}
					add_temporary_windward_level = {
						level = 2
						length = 3650
					}
				}
			}
		}
		
		custom_tooltip = magic_ward_desc_tt
	}
	
	#Rite of Conception
	option = {	#Available
		name = magic_estate.1.k
		trigger = {
			has_consort = yes
			has_government_attribute = heir
			is_lesser_in_union = no
			NOT = { ruler_is_immortal = yes } # No lich babies	
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				ruler_has_mage_personality = yes 
			}
			modifier = {
				factor = 0.5
				has_heir = yes
			}
			modifier = {
				factor = 0.8
				OR = {
					adm = 6
					dip = 6
					mil = 6
				}
			}
			modifier = {
				factor = 0.25
				years_of_income = 1.5
			}
		}
		add_years_of_income = -1
		if = { limit = { has_heir = yes }
			add_legitimacy = -10
		}
		if = { 
			limit = {
				OR = {
					has_country_flag = tughayasa_reward_primary
					has_country_flag = tughayasa_reward
				}
			}
			custom_tooltip = magic_estate_rite_of_conception_tooltip_tt
		}
		else = {
			custom_tooltip = magic_estate_rite_of_conception_tooltip
		}
		hidden_effect = {
			country_event = { id = magic_estate.9 }
		}
		
		custom_tooltip = magic_conception_desc_tt
	}
	option = {	#Unavailable
		name = magic_estate.1.kx
		trigger = {
			ai = no
			OR = {
				has_consort = no
				NOT = { has_government_attribute = heir }
				is_lesser_in_union = yes
				ruler_is_immortal = yes # No lich babies
			}
		}
		
		if = { limit = { has_consort = no }
			custom_tooltip = magic_need_consort_tt
		}
		if = { limit = { NOT = { has_government_attribute = heir } }
			custom_tooltip = magic_government_allow_heirs_tt
		}
		if = { limit = { is_lesser_in_union = yes }
			custom_tooltip = magic_is_not_in_lesser_union_tt
		}
		if = { limit = { ruler_is_immortal = yes }
			custom_tooltip = magic_ruler_is_mortal_tt
		}
		hidden_effect = { country_event = { id = magic_estate.2 } }
		
		custom_tooltip = magic_effect_separator_tt
		
		tooltip = {
			add_years_of_income = -1
			if = { limit = { has_heir = yes }
				add_legitimacy = -10
			}
		}
		custom_tooltip = magic_estate_rite_of_conception_tooltip
		
		custom_tooltip = magic_conception_desc_tt
	}
	
	#Patron summon
	option = {	#Available
		name = magic_estate.1.l
		trigger = {
			#Auirus is a little bitch
			always = no
		}
		#for the future
	}
	option = {	#Not Available
		name = magic_estate.1.lx
		trigger = {
			always = no
		}
		#for the future
	}
}

#
country_event = {
	id = magic_estate.2
	title = magic_estate.2.t
	desc = magic_estate.2.d
	picture = EMPTY_eventPicture
	
	is_triggered_only = yes
	hidden = yes
	
	option = {
		name = magic_estate.2.a
		country_event = { id = magic_estate.1 }
	}
}

# Rite of Conception Outcome Picker
# Old odds ranged from 60% good 25% nothing 15% bad to 5% good 35% bad 60% nothing
# Average condition (33% mage, not powerful mage) - 13.3 heir, 15 no heir + mother dead, 7.5 idiot, 10 heir but mother dead, 45 no heir
country_event = {
	id = magic_estate.9
	title = magic_estate.9.t
	desc = magic_estate.9.d
	picture = NEW_HEIR_eventPicture
	
	hidden = yes
	is_triggered_only = yes
	
	option = {
		# Success, get good magical heir
		name = magic_estate.9.a
		ai_chance = {
			factor = 20
			modifier = {
				factor = 2
				OR = {
					ruler_has_mage_personality = yes
					consort_has_mage_personality = yes
				}
			}
			modifier = {
				factor = 1.33
				estate_influence = {
					estate = estate_mages
					influence = 33
				}
			}
			modifier = {
				factor = 1.33
				estate_influence = {
					estate = estate_mages
					influence = 66
				}
			}
			modifier = {
				factor = 1.2
				OR = {
					ruler_has_personality = fertile_personality
					consort_has_personality = fertile_personality
				}
			}
			modifier = {
				factor = 0.8
				OR = {
					ruler_has_personality = infertile_personality
					consort_has_personality = infertile_personality
				}
			}
		}
		country_event = { id = magic_estate.10 days = 240 random = 60 }
	}
	option = {
		# Failure, mother + child dies in childbirth
		name = magic_estate.9.b
		trigger = {
			NOT = {
				OR = {
					has_country_flag = tughayasa_reward_primary
					has_country_flag = tughayasa_reward
				}
			}
		}
		ai_chance = {
			factor = 20
			modifier = {
				factor = 0.5
				OR = {
					ruler_has_mage_personality = yes
					consort_has_mage_personality = yes
				}
			}
			modifier = {
				factor = 0.75
				estate_influence = {
					estate = estate_mages
					influence = 33
				}
			}
			modifier = {
				factor = 0.75
				estate_influence = {
					estate = estate_mages
					influence = 66
				}
			}
			modifier = {
				factor = 0.8
				OR = {
					ruler_has_personality = fertile_personality
					consort_has_personality = fertile_personality
				}
			}
			modifier = {
				factor = 1.2
				OR = {
					ruler_has_personality = infertile_personality
					consort_has_personality = infertile_personality
				}
			}
		}
		country_event = { id = magic_estate.11 days = 240 random = 60 }
	}

	option = {
		# Semi-success, idiot heir
		name = magic_estate.9.c
		trigger = {
			NOT = {
				OR = {
					has_country_flag = tughayasa_reward_primary
					has_country_flag = tughayasa_reward
				}
			}
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0.75
				estate_influence = {
					estate = estate_mages
					influence = 33
				}
			}
			modifier = {
				factor = 0.75
				estate_influence = {
					estate = estate_mages
					influence = 66
				}
			}
			modifier = {
				factor = 0.8
				OR = {
					ruler_has_personality = fertile_personality
					consort_has_personality = fertile_personality
				}
			}
			modifier = {
				factor = 1.2
				OR = {
					ruler_has_personality = infertile_personality
					consort_has_personality = infertile_personality
				}
			}
		}
		country_event = { id = magic_estate.12 days = 240 random = 60 }
	}
	option = {
		# Semi-success, mother dies in childbirth
		name = magic_estate.9.d
		trigger = {
			NOT = {
				OR = {
					has_country_flag = tughayasa_reward_primary
					has_country_flag = tughayasa_reward
				}
			}
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 1.2
				OR = {
					ruler_has_personality = fertile_personality
					consort_has_personality = fertile_personality
				}
			}
			modifier = {
				factor = 0.8
				OR = {
					ruler_has_personality = infertile_personality
					consort_has_personality = infertile_personality
				}
			}
		}
		country_event = { id = magic_estate.16 days = 240 random = 60 }
	}
	option = {
		# Nothing happens. Flavor event for miscarriage/stillborn
		name = magic_estate.9.e
		trigger = {
			NOT = {
				OR = {
					has_country_flag = tughayasa_reward_primary
					has_country_flag = tughayasa_reward
				}
			}
		}
		ai_chance = {
			factor = 60
			modifier = {
				factor = 0.5
				OR = {
					ruler_has_mage_personality = yes
					consort_has_mage_personality = yes
				}
			}
			modifier = {
				factor = 0.75
				estate_influence = {
					estate = estate_mages
					influence = 33
				}
			}
			modifier = {
				factor = 0.75
				estate_influence = {
					estate = estate_mages
					influence = 66
				}
			}
			modifier = {
				factor = 0.8
				OR = {
					ruler_has_personality = fertile_personality
					consort_has_personality = fertile_personality
				}
			}
			modifier = {
				factor = 1.2
				OR = {
					ruler_has_personality = infertile_personality
					consort_has_personality = infertile_personality
				}
			}
		}
		random_list = {
			50 = {
				#stillborn
				country_event = { id = magic_estate.14 days = 240 random = 60 }
			}
			50 = {
				#miscarriage
				country_event = { id = magic_estate.15 days = 90 random = 180 }
			}
		}
	}
}

# Success event
country_event = {
	id = magic_estate.10
	title = magic_estate.10.t
	desc = magic_estate.10.d
	picture = NEW_HEIR_eventPicture
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			random_list = {
				50 = {
					trigger = { 
						NOT = { 
							ruler_is_harpy = yes
							consort_is_harpy = yes
						} 
					}
					set_ruler_flag = boy_child
				}
				50 = { set_ruler_flag = girl_child }
			}
		}
	}
	after = {
		clr_ruler_flag = girl_child
		clr_ruler_flag = boy_child
	}
	option = {
		name = magic_estate.10.a
		if = {
			limit = { has_heir = yes }
			if = {
				limit =  { has_reform = magical_elite_reform }
				custom_tooltip = magic_estate_magical_elite_heir
			}
			else = {
				custom_tooltip = magic_estate_disinherit_heir
				add_prestige = -50
			}
		}
		if = { 
			limit = {
				has_ruler_flag = boy_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
			}
		}
		if = { 
			limit = {
				has_ruler_flag = girl_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
			    female = yes
			}
		}
		set_heir_mage_effect = yes
	}
	# If an heir was born in the 9 months (don't ask), keep the current heir
	option = {
		name = magic_estate.10.b
		trigger = {
			has_heir = yes
		}
		# Keep current heir
	}
}

# Failure event, female dies, child dies
country_event = {
	id = magic_estate.11
	title = magic_estate.11.t
	desc = magic_estate.11.d
	picture = DEATH_OF_HEIR_eventPicture
	is_triggered_only = yes
	
	option = {
		name = magic_estate.11.a
		if = {
			limit = { is_female = yes }
			kill_ruler = yes
		}
		else = {
			kill_consort = yes
		}
	}
}

# Failure-ish event, idiot magic heir. Likely to be 0/0/0
country_event = {
	id = magic_estate.12
	title = magic_estate.12.t
	desc = magic_estate.12.d
	picture = NEW_HEIR_eventPicture
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			random_list = {
				50 = {
					trigger = { 
						NOT = { 
							ruler_is_harpy = yes
							consort_is_harpy = yes
						} 
					}
					set_ruler_flag = boy_child
				}
				50 = { set_ruler_flag = girl_child }
			}
		}
	}
	after = {
		clr_ruler_flag = girl_child
		clr_ruler_flag = boy_child
	}

	#accept heir
	option = {
		name = magic_estate.12.a

		if = {
			limit = { has_heir = yes }
			if = {
				limit =  { has_reform = magical_elite_reform }
				custom_tooltip = magic_estate_magical_elite_heir
			}
			else = {
				custom_tooltip = magic_estate_disinherit_heir
				add_prestige = -50
			}
		}
		if = { 
			limit = {
				has_ruler_flag = boy_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
				change_adm = -4
			    change_dip = -4
			    change_mil = -4
			}
		}
		if = { 
			limit = {
				has_ruler_flag = girl_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
				change_adm = -4
			    change_dip = -4
			    change_mil = -4
			    female = yes
			}
		}
		set_heir_mage_effect = yes
	}
	# Fortunately, we have this other heir...
	option = {
		trigger = {
			has_heir = yes
		}
		name = magic_estate.12.c
		# Nothing
	}
}

# Unused
# Semi-success event, ruler is drained from the magic, but get heir
country_event = {
	id = magic_estate.13
	title = magic_estate.13.t
	desc = magic_estate.13.d
	picture = KING_SICK_IN_BED_eventPicture
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			random_list = {
				50 = {
					trigger = { 
						NOT = { 
							ruler_is_harpy = yes
							consort_is_harpy = yes
						} 
					}
					set_ruler_flag = boy_child
				}
				50 = { set_ruler_flag = girl_child }
			}
		}
	}

	option = {
		name = magic_estate.13.a
		random = {
			chance = 33
			change_adm = -1
		}
		random = {
			chance = 33
			change_dip = -1
		}
		random = {
			chance = 33
			change_mil = -1
		}
		if = {
			limit = { has_heir = yes }
			if = {
				limit =  { has_reform = magical_elite_reform }
				custom_tooltip = magic_estate_magical_elite_heir
			}
			else = {
				custom_tooltip = magic_estate_disinherit_heir
				add_prestige = -50
			}
		}
		if = { 
			limit = {
				has_ruler_flag = boy_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
			}
		}
		if = { 
			limit = {
				has_ruler_flag = girl_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
				female = yes
			}
		}
		set_heir_mage_effect = yes
	}
	# If an heir was born in the 9 months (don't ask), keep the current heir
	option = {
		name = magic_estate.10.b
		trigger = {
			has_heir = yes
		}
		# Keep current heir
	}
	after = {
		clr_ruler_flag = girl_child
		clr_ruler_flag = boy_child
	}
}

# Failure, nothing happens - Stillborn
country_event = {
	id = magic_estate.14
	title = magic_estate.14.t
	desc = magic_estate.14.d
	picture = NEW_HEIR_eventPicture
	is_triggered_only = yes
	
	option = {
		name = magic_estate.14.a
		# nothing
	}
}

# Failure, nothing happens - Miscarriage
country_event = {
	id = magic_estate.15
	title = magic_estate.15.t
	desc = magic_estate.15.d
	picture = NEW_HEIR_eventPicture
	is_triggered_only = yes
	
	option = {
		name = magic_estate.15.a
		# nothing
	}
}

# Female dies, child lives
country_event = {
	id = magic_estate.16
	title = magic_estate.16.t
	desc = magic_estate.16.d
	picture = DEATH_OF_HEIR_eventPicture
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			random_list = {
				50 = {
					trigger = { 
						NOT = { 
							ruler_is_harpy = yes
							consort_is_harpy = yes
						} 
					}
					set_ruler_flag = boy_child
				}
				50 = { set_ruler_flag = girl_child }
			}
		}
	}
	after = {
		clr_ruler_flag = girl_child
		clr_ruler_flag = boy_child
	}
	option = {
		name = magic_estate.16.a
		if = {
			limit = { has_heir = yes }
			if = {
				limit =  { has_reform = magical_elite_reform }
				custom_tooltip = magic_estate_magical_elite_heir
			}
			else = {
				custom_tooltip = magic_estate_disinherit_heir
				add_prestige = -50
			}
		}
		if = { 
			limit = {
				has_ruler_flag = boy_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
			}
		}
		if = { 
			limit = {
				has_ruler_flag = girl_child
			}
			define_heir = {
				dynasty = ROOT
				claim = 100
				female = yes
			}
		}
		set_heir_mage_effect = yes
		if = {
			limit = { is_female = yes }
			kill_ruler = yes
		}
		else = {
			kill_consort = yes
		}
	}
	# If an heir was born in the 9 months (don't ask), keep the current heir
	option = {
		name = magic_estate.16.b
		trigger = {
			has_heir = yes
		}
		# Keep current heir but mother stills dies
		if = {
			limit = { is_female = yes }
			kill_ruler = yes
		}
		else = {
			kill_consort = yes
		}
	}
}

# Cleanup event to not get ahead of neighbors after embracing an institution
country_event = {
	id = magic_estate.17
	title = magic_estate.17.t
	desc = magic_estate.17.d
	picture = DEATH_OF_HEIR_eventPicture
	
	mean_time_to_happen = { days = 1 }
	hidden = yes
	
	trigger = {
		any_owned_province = {
			OR = {
				has_province_modifier = magic_estate_scrying_stealing_institution_1
				has_province_modifier = magic_estate_scrying_stealing_institution_2
				has_province_modifier = magic_estate_scrying_stealing_institution_3
			}
		}
		neighbor_is_ahead_in_institution = no
	}
	option = {
		name = magic_estate.17.a
		every_owned_province = {
			remove_province_modifier = magic_estate_scrying_stealing_institution_1
			remove_province_modifier = magic_estate_scrying_stealing_institution_2
			remove_province_modifier = magic_estate_scrying_stealing_institution_3
		}
	}
}

# Magisterium demands switch back
country_event = {
	id = magic_estate.18
	title = magic_estate.18.t
	desc = magic_estate.18.d
	picture = ACCUSATION_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		is_part_of_hre = yes
		exists = A85
		NOT = { has_estate_privilege = estate_mages_organization_magisterium } #in case someone flipped back
	}
	
	option = { # Refuse
		name = magic_estate.18.a
		reverse_add_casus_belli = {
			target = A85
			type = cb_insult
			months = 120
		}
		reverse_add_opinion = {
			who = A85
			modifier = refused_magisterium_org
		}
	}
	
	option = { # Accept
		name = magic_estate.18.b
		custom_tooltip = magic_estate_returned_to_magisterium_tooltip
		hidden_effect = {
			clear_mages_organization_effect = yes
			set_estate_privilege = estate_mages_organization_magisterium
		}
	}
}

########################
#### AI and DEBUG events
########################

# Devastation ticking up event
country_event = {
	id = magic_estate.100
	title = magic_estate.100.t
	desc = magic_estate.100.d
	picture = ACCUSATION_eventPicture
	
	is_triggered_only = yes
	hidden = yes
	
	trigger = {
		NOT = { has_country_flag = better_plant_growth } # Eilisin methods avoid this
		NOT = { has_country_flag = vacyntassi_magical_focus_order_flag } #Eduz-Vacyn has Gardening power
		NOT = { has_country_flag = mihipha_gardening_flag } #Great University, Mihipha gain experience there to avoid mistakes
	}
	
	# suck for u lol
	option = {
		name = magic_estate.100.a
		if = {
			limit = { estate_loyalty = { estate = estate_mages loyalty = 70 } }
			every_owned_province = {
				limit = {
					OR = {
						has_province_modifier = magic_realm_transmutation_plant_growth_1
						has_province_modifier = magic_realm_transmutation_plant_growth_2
						has_province_modifier = magic_realm_transmutation_plant_growth_3
					}
				}
				add_devastation = 1
				random = {
					chance = 5
					add_devastation = 1
				}
			}
		}
		else_if = {
			limit = { estate_loyalty = { estate = estate_mages loyalty = 50 } }
			every_owned_province = {
				limit = {
					OR = {
						has_province_modifier = magic_realm_transmutation_plant_growth_1
						has_province_modifier = magic_realm_transmutation_plant_growth_2
						has_province_modifier = magic_realm_transmutation_plant_growth_3
					}
				}
				add_devastation = 1
				random = {
					chance = 10
					add_devastation = 1
				}
			}
		}
		else_if = {
			limit = { estate_loyalty = { estate = estate_mages loyalty = 30 } }
			every_owned_province = {
				limit = {
					OR = {
						has_province_modifier = magic_realm_transmutation_plant_growth_1
						has_province_modifier = magic_realm_transmutation_plant_growth_2
						has_province_modifier = magic_realm_transmutation_plant_growth_3
					}
				}
				add_devastation = 1
				random = {
					chance = 15
					add_devastation = 1
				}
			}
		}
		else = {
			every_owned_province = {
				limit = {
					OR = {
						has_province_modifier = magic_realm_transmutation_plant_growth_1
						has_province_modifier = magic_realm_transmutation_plant_growth_2
						has_province_modifier = magic_realm_transmutation_plant_growth_3
					}
				}
				add_devastation = 1
				random = {
					chance = 20
					add_devastation = 1
				}
			}
		}
		change_variable = { pGrowthNb = 1 }
		if = {
			limit = { check_variable = { pGrowthNb = 10 } }
			set_variable = { pGrowthNb = 0 }
		}
		else = {
			country_event = { id = magic_estate.100 days = 365 }
		}
	}
}