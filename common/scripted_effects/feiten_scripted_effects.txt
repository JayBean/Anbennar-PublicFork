
# Some Feiten stuff
feiten_update_shuimu_capacity = {
	set_variable = {
		which = feiten_shuimu_bonus_cap
		value = 5
	}
	if = {
		limit = { current_age = age_of_absolutism }
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 5
		}
	}
	else_if = {
		limit = { current_age = age_of_revolutions }
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 10
		}
	}
	if = {
		limit = {
			estate_territory = {
				estate = estate_artificers
				territory = 50
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 10
		}
	}
	else_if = {
		limit = {
			estate_territory = {
				estate = estate_artificers
				territory = 40
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 8
		}
	}
	else_if = {
		limit = {
			estate_territory = {
				estate = estate_artificers
				territory = 30
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 6
		}
	}
	else_if = {
		limit = {
			estate_territory = {
				estate = estate_artificers
				territory = 20
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 4
		}
	}
	else_if = {
		limit = {
			estate_territory = {
				estate = estate_artificers
				territory = 10
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 2
		}
	}
	if = {
		limit = {
			4879 = {
				has_great_project = {
					type = feiten_aerodrome
					tier = 3
				}
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 20
		}
	}
	else_if = {
		limit = {
			4879 = {
				has_great_project = {
					type = feiten_aerodrome
					tier = 2
				}
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 10
		}
	}
	else_if = {
		limit = {
			4879 = {
				has_great_project = {
					type = feiten_aerodrome
					tier = 1
				}
			}
		}
		change_variable = {
			which = feiten_shuimu_bonus_cap
			value = 5
		}
	}
	change_variable = {
		which = feiten_shuimu_bonus_cap
		which = feitenActiveSkyports
	}
	export_to_variable = {
		which = feiten_current_stated_provinces
		value = trigger_value:num_of_provinces_in_states
		who = Y20
	}

	set_variable = {
		which = feiten_province_balance
		which = feiten_current_stated_provinces
	}
	
	subtract_variable = { 
		which = feiten_province_balance
		which = feiten_shuimu_bonus_cap
	}
	if = {
		limit = {
			check_variable = {
				which = feiten_province_balance
				value = 1
			}
		}
		divide_variable = {
			which = feiten_province_balance
			which = feiten_shuimu_bonus_cap
		}
	}
	log = "[1371.feiten_current_stated_provinces.GetName]: [1371.feiten_current_stated_provinces.GetValue]"
	log = "[1371.feiten_shuimu_bonus_cap.GetName]: [1371.feiten_shuimu_bonus_cap.GetValue]"
}

# Update Feiten 'Experimentals' stuff
feiten_update_stasis_experimental = {
	if = {
		limit = { has_country_flag = feiten_stasis_field_active }
		random_hired_mercenary_company = {
			limit = { template = merc_feiten_stasis }
			location = {
				# Yes, this sucks codewise
				every_neighbor_province = { every_neighbor_province = { remove_province_modifier = feiten_stasis_field } } # Remove province mod from the province you just traveled from
				every_neighbor_province = {
					limit = { controller = { war_with = ROOT } }
					add_province_modifier = { name = feiten_stasis_field duration = 30 } # Reapply province mod to the province you're on
				}
			}
		}
	}
}

feiten_update_firestorm_experimental = {
	if = {
		limit = { has_country_flag = feiten_firestorm_active }
		random_hired_mercenary_company = {
			limit = { template = merc_feiten_firestorm }
			location = {
				# Yes, this sucks codewise
				every_neighbor_province = { every_neighbor_province = { remove_province_modifier = feiten_firestorm } } # Remove province mod from the province you just traveled from
				every_neighbor_province = {
					limit = { controller = { war_with = ROOT } }
					add_province_modifier = { name = feiten_firestorm duration = 30 }
				}
			}
		}
	}
}

feiten_update_skyfactory_experimental = {
	if = {
		limit = { has_country_flag = feiten_skyfactory_active }
		random_hired_mercenary_company = {
			limit = { template = merc_feiten_sky_factory }
			location = {
				# Yes, this sucks codewise
				every_neighbor_province = { every_neighbor_province = { remove_province_modifier = feiten_skyfactory } } # Remove province mod from the province you just traveled from
				every_neighbor_province = {
					limit = { country_or_non_sovereign_subject_holds = Y20 }
					add_province_modifier = { name = feiten_skyfactory duration = 30 }
				}
				if = {
					limit = { country_or_non_sovereign_subject_holds = Y20 }
					add_province_modifier = { name = feiten_skyfactory duration = 30 }
				}
			}
		}
	}
}

feiten_update_jellyfish_scouts = {
	if = {
		limit = { any_hired_mercenary_company = { template = merc_feiten_jellyfish_scouts location = { country_or_non_sovereign_subject_holds = Y20 } } }
		random_hired_mercenary_company = {
			limit = { template = merc_feiten_jellyfish_scouts }
			location = {
				add_province_modifier = {
					name = feiten_jellyfish_scouts_friendly
					duration = 180
				}
			}
		}
	}
	else_if = {
		limit = { any_hired_mercenary_company = { template = merc_feiten_jellyfish_scouts location = { controller = { war_with = Y20 } } } }
		random_hired_mercenary_company = {
			limit = { template = merc_feiten_jellyfish_scouts  }
			location = {
				add_province_modifier = {
					name = feiten_jellyfish_scouts_hostile
					duration = 180
				}
			}
		}
	}
}

feiten_pick_skyport_location_in = {
	home_trade_node_effect_scope = {
		random_trade_node_member_province = {
			limit = {
				province_has_center_of_trade_of_level = 1
				owned_by = FROM
			}
		}
	}
}

feiten_update_skyport_balance = {
	set_variable = {
		which = feitenSkyportCap
		value = 0
	}
	if = {
		limit = {
			4879 = {
				has_great_project = {
					type = feiten_aerodrome
					tier = 3
				}
			}
		}
		change_variable = {
			which = feitenSkyportCap
			value = 20
		}
	}
	else_if = {
		limit = {
			4879 = {
				has_great_project = {
					type = feiten_aerodrome
					tier = 2
				}
			}
		}
		change_variable = {
			which = feitenSkyportCap
			value = 10
		}
	}
	else_if = {
		limit = {
			4879 = {
				has_great_project = {
					type = feiten_aerodrome
					tier = 1
				}
			}
		}
		change_variable = {
			which = feitenSkyportCap
			value = 5
		}
	}
	set_variable = {
		which = feitenSkyportBalance
		which = feitenSkyportCap
	}
	subtract_variable = {
		which = feitenSkyportBalance
		which = feitenActiveSkyports
	}
}

feiten_update_skypost_duty = {
	set_variable = {
		which = feitenSkypostDutyEff
		value = 20
	}
	set_variable = {
		which = feitenSkypostDutyEffFromInventions
		value = 0
	}
	if = {
		limit = {
			has_global_modifier_value = {
				which = trade_efficiency
				value = 1
			}
		}
		change_variable = {
			which = feitenSkypostDutyEff
			value = 20
		}
	}
	else_if = {
		limit = {
			has_global_modifier_value = {
				which = trade_efficiency
				value = 0.66
			}
		}
		change_variable = {
			which = feitenSkypostDutyEff
			value = 10
		}
	}
	else_if = {
		limit = {
			has_global_modifier_value = {
				which = trade_efficiency
				value = 0.33
			}
		}
		change_variable = {
			which = feitenSkypostDutyEff
			value = 5
		}
	}
	if = {
		limit = { mercantilism = 100 }
		change_variable = {
			which = feitenSkypostDutyEff
			value = 20
		}
	}
	else_if = {
		limit = { mercantilism = 66 }
		change_variable = {
			which = feitenSkypostDutyEff
			value = 10
		}
	}
	else_if = {
		limit = { mercantilism = 33 }
		change_variable = {
			which = feitenSkypostDutyEff
			value = 5
		}
	}
	if = {
		limit = {
			has_estate_privilege = artifice_invention_feiten_expanding_storage_holds
			trading_bonus = {
				trade_goods = tropical_wood
				value = yes
			}
		}
		change_variable = {
			which = feitenSkypostDutyEff
			value = 10
		}
		change_variable = {
			which = feitenSkypostDutyEffFromInventions
			value = 10
		}
	}
	else_if = {
		limit = { has_estate_privilege = artifice_invention_feiten_expanding_storage_holds }
		change_variable = {
			which = feitenSkypostDutyEff
			value = 5
		}
		change_variable = {
			which = feitenSkypostDutyEffFromInventions
			value = 5
		}
	}
	if = {
		limit = {
			has_estate_privilege = artifice_invention_feiten_silken_cladding
			trading_bonus = {
				trade_goods = silk
				value = yes
			}
		}
		change_variable = {
			which = feitenSkypostDutyEff
			value = 10
		}
		change_variable = {
			which = feitenSkypostDutyEffFromInventions
			value = 10
		}
	}
	else_if = {
		limit = { has_estate_privilege = artifice_invention_feiten_silken_cladding }
		change_variable = {
			which = feitenSkypostDutyEff
			value = 5
		}
		change_variable = {
			which = feitenSkypostDutyEffFromInventions
			value = 5
		}
	}
	if = {
		limit = {
			has_estate_privilege = artifice_invention_feiten_porcelain_caged_firebirds
			trading_bonus = {
				trade_goods = chinaware
				value = yes
			}
		}
		change_variable = {
			which = feitenSkypostDutyEff
			value = 10
		}
		change_variable = {
			which = feitenSkypostDutyEffFromInventions
			value = 10
		}
	}
	else_if = {
		limit = { has_estate_privilege = artifice_invention_feiten_porcelain_caged_firebirds }
		change_variable = {
			which = feitenSkypostDutyEff
			value = 5
		}
		change_variable = {
			which = feitenSkypostDutyEffFromInventions
			value = 5
		}
	}
}

feiten_update_skypost_trade_modifiers = {
	every_province = {
		limit = { has_active_triggered_province_modifier = feiten_skyport_handler_mod }
		remove_trade_modifier = { who = Y20 key = "Feiten Skypost" }
		if = {
			limit = {
				check_variable = {
					which = feitenActiveSkyports
					value = 20
				}
			}
			add_trade_modifier = {
				who = Y20
				duration = -1
				power = 50
				key = "Feiten Skypost"
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = feitenActiveSkyports
					value = 15
				}
			}
			add_trade_modifier = {
				who = Y20
				duration = -1
				power = 40
				key = "Feiten Skypost"
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = feitenActiveSkyports
					value = 10
				}
			}
			add_trade_modifier = {
				who = Y20
				duration = -1
				power = 30
				key = "Feiten Skypost"
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = feitenActiveSkyports
					value = 5
				}
			}
			add_trade_modifier = {
				who = Y20
				duration = -1
				power = 20
				key = "Feiten Skypost"
			}
		}
		else = {
			add_trade_modifier = {
				who = Y20
				duration = -1
				power = 10
				key = "Feiten Skypost"
			}
		}
	}
}

feiten_update_invention_bonuses = {
	if = {
		limit = { has_estate_privilege = artifice_invention_feiten_long_rockets }
		if = {
			limit = {
				trading_bonus = {
					trade_goods = coal
					value = yes
				}
			}
			remove_country_modifier = feiten_long_rockets_mod
			add_country_modifier = {
				name = feiten_long_rockets_mod_upgraded
				duration = -1
			}
		}
		else = {
			remove_country_modifier = feiten_long_rockets_mod_upgraded
			add_country_modifier = {
				name = feiten_long_rockets_mod
				duration = -1
			}
		}
	}
	if = {
		limit = { has_estate_privilege = artifice_invention_feiten_specialized_construction_arms }
		every_owned_province = {
			if = {
				limit = {
					OR = {
						has_terrain = mountain
						has_terrain = highlands
						has_terrain = hills
					}
				}
				if = {
					limit = {
						Y20 = {
							trading_bonus = {
								trade_goods = naval_supplies
								value = yes
							}
						}
					}
					remove_province_modifier = feiten_specialized_construction_arms_mod
					add_province_modifier = {
						name = feiten_specialized_construction_arms_mod_upgraded
						duration = -1
					}
				}
				else = {
					remove_province_modifier = feiten_specialized_construction_arms_mod_upgraded
					add_province_modifier = {
						name = feiten_specialized_construction_arms_mod
						duration = -1
					}
				}
			}
			else_if = {
				limit = {
					OR = {
						has_province_modifier = feiten_specialized_construction_arms_mod
						has_province_modifier = feiten_specialized_construction_arms_mod_upgraded
					}
				}
				remove_province_modifier = feiten_specialized_construction_arms_mod_upgraded
				remove_province_modifier = feiten_specialized_construction_arms_mod				
			}
		}
	}
	if = {
		limit = { has_estate_privilege = artifice_invention_feiten_electroplated_armor }
		if = {
			limit = {
				trading_bonus = {
					trade_goods = copper
					value = yes
				}
			}
			remove_country_modifier = feiten_electroplated_armor_mod
			add_country_modifier = {
				name = feiten_electroplated_armor_mod_upgraded
				duration = -1
			}
		}
		else = {
			remove_country_modifier = feiten_electroplated_armor_mod_upgraded
			add_country_modifier = {
				name = feiten_electroplated_armor_mod
				duration = -1
			}
		}
	}
	if = {
		limit = { has_estate_privilege = artifice_invention_feiten_damestear_ribbing }
		if = {
			limit = {
				trading_bonus = {
					trade_goods = damestear
					value = yes
				}
			}
			remove_country_modifier = feiten_damestear_ribbing_mod
			add_country_modifier = {
				name = feiten_damestear_ribbing_mod_upgraded
				duration = -1
			}
		}
		else = {
			remove_country_modifier = feiten_damestear_ribbing_mod_upgraded
			add_country_modifier = {
				name = feiten_damestear_ribbing_mod
				duration = -1
			}
		}
	}
	if = {
		limit = { has_estate_privilege = artifice_invention_feiten_long_rockets }
		if = {
			limit = {
				trading_bonus = {
					trade_goods = coal
					value = yes
				}
			}
			remove_country_modifier = feiten_long_rockets_mod
			add_country_modifier = {
				name = feiten_long_rockets_mod_upgraded
				duration = -1
			}
		}
		else = {
			remove_country_modifier = feiten_long_rockets_mod_upgraded
			add_country_modifier = {
				name = feiten_long_rockets_mod
				duration = -1
			}
		}
	}
	if = {
		limit = { has_estate_privilege = artifice_invention_feiten_long_rockets }
		if = {
			limit = {
				trading_bonus = {
					trade_goods = iron
					value = yes
				}
			}
			remove_country_modifier = feiten_bluesteel_rudders_mod
			add_country_modifier = {
				name = feiten_bluesteel_rudders_mod_upgraded
				duration = -1
			}
		}
		else = {
			remove_country_modifier = feiten_bluesteel_rudders_mod_upgraded
			add_country_modifier = {
				name = feiten_bluesteel_rudders_mod
				duration = -1
			}
		}
	}
}